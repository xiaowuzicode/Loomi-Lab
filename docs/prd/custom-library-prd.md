## 自定义库与公域表改造 PRD（v1）

### 一、背景与目标
- 将现有“自定义字段管理”能力重构为两块：
  - 自定义库（只读浏览）
  - 创建公域表（保留原有增删改查能力）
- 需求要点：
  - 名称替换：页面名称由“自定义字段管理”改为“自定义库”。
  - 类型不再固定为“洞察/钩子/情绪”，改为“可自定义类型”，创建表时由用户直接填写 `type`（任意字符串）。
  - 自定义库页仅支持查看：在顶部输入并显示 `user_id`，点击“加载”后，以“扁平列表”展示该用户的所有表（不再分类型分组）；类型以标签形式展示在表名旁；可选提供 type 过滤与关键字搜索。交互参考“备忘录/帖子库”的右上角“加载”逻辑。
  - 增加一个 Tab：“创建公域表”，迁移当前表格化管理的增删改查逻辑至此；“公域表”归属固定在用户 `09681d4b-a5cd-45a5-b0e4-d54ef5f2c2bb`（存在于用户表，可作为外键）（而不是之前的00000000-0000-4000-8000-000000000001了，用户表中没有，不规范）。
  - 导入数据时取消“必填字段”前端校验；如后端仍需兼容字段（例如“标题”），由前端在提交前自动补齐（空值），以实现后端“少改”。
  - 后端无需新增接口；`/api/custom-fields` 已支持通过 `type` 进行筛选（前端可利用）。如后端存在固定枚举校验，则放宽为任意字符串。

非目标：
- 不改动现有 `book_user_custom_fields` 表结构与既有 CRUD 语义。

### 二、术语定义
- 自定义库：以用户 `user_id` 为维度，按“表 -> 表数据”扁平展示（类型仅作标签显示）的只读浏览界面。
- 公域表：归属固定在用户 `09681d4b-a5cd-45a5-b0e4-d54ef5f2c2bb` 的自定义表集合，可创建/编辑/导入。
- 类型（Type）：自定义表的分类标签，文本可自由命名。

### 三、信息架构与导航
- 页面入口重命名为“自定义库”。
- 顶部 Tabs：
  - Tab1：自定义库（只读）
  - Tab2：创建公域表（可增删改查）

### 四、交互设计

#### 4.1 自定义库（只读）
参考 `app/memo-folders/page.tsx` 与 `app/posts-library/page.tsx` 的“输入 userId + 加载 + 左列表右详情”模式：
- 顶部区域：
  - 文案标题：自定义库
  - 输入框：`user_id`（UUID）
  - 按钮：加载（禁用条件：无 `user_id`）
- 加载后左侧列表（扁平）：
  - 表清单以行展示：表名 + 类型 Badge + 行数 + 更新时间；
  - 提供关键字搜索（表名）与 type 过滤（来自已加载数据的去重集合）。
- 右侧详情：
  - 表基础信息：表名、类型、创建者、时间等。
  - 表数据只读表格视图（复用现有 `DataTable` 的展示形态，但禁用增删改控件，仅滚动浏览）。
- 搜索（可选 v1.1）：
  - 搜索当前类型下的表名或表内标题字段（若存在）。
- 空态/异常：
  - 未加载：提示“输入用户ID并点击‘加载’以查看自定义库”。
  - 无数据：提示“暂无表”。
  - 错误：Chakra `Alert` 提示。

权限与安全：
- 该页只读展示；数据读取需要 `user_id`，交付环境下配合网关鉴权（本 PRD 不扩展）。

#### 4.2 创建公域表（可编辑）
- Tab 标题：创建公域表。
- 归属固定用户：`09681d4b-a5cd-45a5-b0e4-d54ef5f2c2bb`（以下简称 PUBLIC_USER_ID）。
- 默认展示与管理对象：PUBLIC_USER_ID 名下所有自定义表（管理员视角）。
  - 左侧：以“扁平列表”列出 PUBLIC_USER_ID 的全部表（支持搜索与类型筛选，下拉来自当前列表的去重 `type`）。
  - 右侧：选择表后进入可编辑视图（字段/行/导入/导出/统一保存/删除）。
- 能力迁移自现有“自定义字段管理”表格化页面（`/custom-fields/table`）：
  - 新建表、字段增删改、行增删改、复制行、Excel 导入/导出、统一保存、软删除等。
- 调整点：
  - 导入取消必填字段限制：前端不要求“标题”等必填；若后端仍要求“标题”，前端在提交创建/导入前自动补齐缺失字段（置空字符串），以保持后端“零/微改”。
  - 类型填写：创建/复制表时提供 `type` 输入框（任意字符串）；编辑表的 `type` 可修改并保存。
  - 所有创建/更新/删除请求自动使用 `userId = PUBLIC_USER_ID` 与 `createdUserId = PUBLIC_USER_ID`。
  - UI 文案同步：移除“标题为必填”的提示与徽标；导入说明同步更新。

### 五、数据模型与兼容
- 仍沿用 `book_user_custom_fields`：
  - `extended_field` 为行数组，首行 Keys 推导 `tableFields`（保持现有 transform 逻辑）。
  - 金额单位：存分、显元（保持现状）。
  - 软删除：`is_deleted=true`（保持现状）。
- 取消必填的兼容策略：
  - 取消“标题”的导入必填与创建表自动新增逻辑（创建完新表就是什么字段也没有的状态）

### 六、API 方案（最小改动优先）

#### 6.1 现有接口复用
- 列表/详情/统计：`GET /api/custom-fields`（带 `userId` 与 `action`）。
- 字段操作：`PUT /api/custom-fields/fields`。
- 行操作：`POST|PUT|DELETE /api/custom-fields/rows`。
- 创建/更新/删除表：`POST|PUT|DELETE /api/custom-fields`。

公域表页的调用约定：
- 列表/详情查询：固定 `userId = PUBLIC_USER_ID`；
- 创建/更新/删除/字段/行操作：固定 `userId = createdUserId = PUBLIC_USER_ID`；
- 类型列表：`GET /types?scope=public`。

（已删除：新增类型接口方案。本版本后端无需新增接口。）

### 七、页面与组件改造清单（前端）
1) 路由与命名：
   - 页面标题统一“自定义库”。
   - 在自定义库入口新增 Tabs，Tab2 为“创建公域表”。
2) 自定义库（只读）页：
   - 参考 `posts-library` 的“输入 userId + 加载 + 左列表右详情”模式；
   - 数据源：`GET /api/custom-fields?action=list&userId=...` 拉取表清单，前端维护 `type` 去重集合用于过滤；
   - 详情视图：复用 `DataTable` 但隐藏/禁用所有编辑控件（新增行、字段管理、删除等）。
3) 创建公域表页：
   - 复用 `table-page.tsx` 的交互（表/字段/行/导入/导出/统一保存）；
   - 所有请求自动使用 `userId=createdUserId=PUBLIC_USER_ID`；
   - 导入模态 `ImportModal`：移除“标题必需”提示与校验；提交前若缺少“标题”，前端自动补齐空列。
   - 类型输入：创建/编辑表单中为 `type` 的自由文本输入框。

### 八、验收标准
- 自定义库页：
  - 输入合法 `user_id` 点击“加载”后，左侧出现动态类型分组与表清单；
  - 点击表能在右侧以只读表格查看数据；
  - 不出现任何编辑入口（无新增/删除/重命名/导入按钮）。
- 创建公域表页：
  - 能看到 PUBLIC_USER_ID 名下的全部表清单并进入编辑；
  - 能从下拉选择已有类型，或新增类型成功；
  - 能导入不含“标题”字段的 Excel，前端自动补齐后成功创建；
  - 能进行字段增删改与行增删改，并统一保存；
  - 支持软删除现有公域表；
  - 新建/更新/删除的 `user_id/created_user_id` 固定为 `09681d4b-a5cd-45a5-b0e4-d54ef5f2c2bb`。

### 九、埋点/可观测（可选）
- 关键事件：加载点击、加载成功/失败、切换类型、查看表详情、导入开始/成功/失败、保存更改成功/失败、创建/删除表。
- 指标：加载时延、导入耗时、保存耗时、错误率。

### 十、风险与回退
- 风险：
  - 前端取消必填后与后端校验不一致 → 通过前端自动补齐“标题”缓解。
  - 类型注册非强一致（方案A）→ 首次创建表即“落地”，对体验影响可接受。
- 回退：
  - 若上线后出现类型展示异常，可临时退回仅以 distinct 展示，隐藏“新增类型”。

### 十一、里程碑与实现顺序
M1（前端为主，后端零接口改动）：
1. 自定义库只读页（含加载交互、扁平列表、详情只读、type 过滤/搜索）。
2. 创建公域表页（复用现有表格化交互，固定 PUBLIC_USER_ID，导入去必填、自动补齐“标题”，创建/编辑可填写任意 type）。

### 附：关键常量
- PUBLIC_USER_ID：`09681d4b-a5cd-45a5-b0e4-d54ef5f2c2bb`


### 十二、前端详细设计：自定义库（只读）

1) 路由与文件
- 路由：`/custom-library`（替代原“自定义字段管理”入口）。
- 页面文件建议：`app/custom-library/page.tsx`。
- 复用组件：`components/custom-fields/DataTable`（只读）、`components/ui/Card`、`PageLayout`、Chakra 组件库。

2) 布局结构（左列表/右详情）
- Header：标题、自定义 `Input[userId]` + `Button[加载]`、`Input[search]`、`Select[typeFilter]`
- 左侧列表（扁平）：表名 + `Badge[type]` + 行数 + 更新时间；Skeleton/空态
- 右侧详情：基本信息 + Tabs（数据/说明/示例），数据 Tab 复用 `DataTable` 的只读渲染

3) 只读表格渲染
- 为 `DataTable` 增加 `readOnly?: boolean`；为 true 时隐藏新增/删除/复制/字段管理/统一保存入口；`EditableCell` 保持浏览态。
- 或封装 `ReadOnlyTable` 包装器，传入空实现的 handler 达成只读。

4) 状态与 Hook（新）
- `useCustomLibrary`：`userId, loading, tables, selectedTable, search, typeFilter, error`
- API：列表 `GET /api/custom-fields?action=list&userId=...&type?=&search?=`；详情 `GET /api/custom-fields?id=...&userId=...`
- 方法：`loadTables`、`loadDetail`、`setSearch`、`setTypeFilter`

5) 交互
- 初次进入不自动加载；输入 `userId` 后点击“加载”
- 搜索/过滤优先走后端参数；也可前端二次过滤
- 移动端纵向布局；支持虚拟滚动

### 十三、前端详细设计：创建公域表（可编辑）

1) 路由与文件
- 路由：`/custom-library/public` 或作为 `/custom-library` 页内 Tab2。
- 页面文件：`app/custom-library/public/page.tsx`（若独立路由）。
- 复用组件：`DataTable`、`ImportModal`（去必填文案）、`TableToolbar`（按钮调整）。

2) 布局（左列表/右编辑）
- Header：标题、`Input[search]`、`Select[typeFilter]`
- 左侧列表：PUBLIC_USER_ID 的全部表（扁平），行项含表名 + `Badge[type]` + 行数 + 更新时间
- 右侧编辑区：
  - `TableToolbar`：新建表（Modal：表名、type、readme、visibility、isPublic、amount；固定 `userId=createdUserId=PUBLIC_USER_ID`）、导入、导出、刷新、保存更改/取消修改
  - 数据表格：`DataTable` 完整可编辑（字段/行/复制/统一保存）

3) 变更点与校验
- type：自由文本输入；下拉自动补全（来源：左侧列表去重 type）
- 导入：仅做格式校验；若缺 `标题`，提交前自动补齐 `标题: ''`
- 保存顺序：字段重命名 -> 单元格更新 -> 新增行（沿用现逻辑）
- 删除表：软删除并刷新列表；若删除当前表则清空右侧

4) Hook 与状态
- 复用 `useTableCustomFields` 并在封装处统一注入 `userId=PUBLIC_USER_ID`；
- 新增 `type` 参数在创建/更新时透传；
- 维护 `search/typeFilter` 与 `filteredTables`。

5) 验收示例
- 自定义库页：加载 -> 过滤 -> 查看任意表详情（只读，无编辑入口）
- 公域表页：新建/导入（缺“标题”也能成功） -> 字段/行编辑并统一保存 -> 删除表后列表与详情同步更新

### 十四、页面低保真线框图（最终呈现形态）

1) 自定义库（只读）

```text
┌───────────────────────────────────────────────────────────────────────────────┐
│ 自定义库                                                [userId输入][加载]   │
│ 搜索: [关键词……]   类型: [全部▼]                                            │
├───────────────────────────────────────────────────────────────────────────────┤
│  左侧表清单（扁平）                                  │  右侧详情（Tabs）      │
│  ┌──────────────────────────────┐                   │  ┌───────────┬──────┬──┐│
│  │ ● 表名A             [typeX] │ 行:123  更新时间  │  │ 数据(只读)│说明 │示例││
│  │ ● 表名B很长…        [typeY] │ 行: 45  更新时间  │  ├───────────┴──────┴──┤│
│  │ ● 表名C             [typeX] │ 行:  6  更新时间  │  表头: [ID][标题][正文][…]│
│  │ …（支持滚动/高亮选中）  │                      │  ───────────────────────  │
│  └──────────────────────────────┘                   │  只读单元格（无编辑按钮）│
│                                                     │  底部：翻页/统计（可选） │
└─────────────────────────────────────────────────────┴─────────────────────────┘
说明：
- 列表项：图标/表名/Badge(类型)/行数/最近更新时间；选中高亮。
- 详情顶部（未画出）：表名、类型、创建者、创建/更新日期、行数。
- 数据Tab复用 DataTable，但隐藏新增、删除、复制、字段管理、保存等操作。
```

2) 创建公域表（可编辑）

```text
┌───────────────────────────────────────────────────────────────────────────────┐
│ 创建公域表                                   搜索: [关键词…]  类型: [全部▼]  │
├───────────────────────────────────────────────────────────────────────────────┤
│  左侧表清单（PUBLIC_USER_ID 全部表）       │  右侧编辑区                     │
│  ┌──────────────────────────────┐          │  ┌──────────────────────────────┐│
│  │ [+ 新建表]  [+ 导入]          │          │  工具栏： 保存更改(●3)  取消修改 ││
│  │ ● 表名A             [typeX] │          │         导出  刷新               ││
│  │ ● 表名B很长…        [typeY] │          │  ────────────────────────────── ││
│  │ ● 表名C             [typeZ] │          │  未保存提示条(橙色)（可隐藏）     ││
│  │ …（支持滚动/筛选/高亮选中） │          │  ┌ 表格(DataTable，可编辑) ┐   ││
│  └──────────────────────────────┘          │  │[ID][标题][正文][字段+][操作]│   ││
│                                            │  │ 行内编辑/复制/删除/新增行     ││
│                                            │  └───────────────────────────┘   ││
│                                            │  底部：批量操作栏(导出/删除等)   ││
└────────────────────────────────────────────┴──────────────────────────────────┘
新建表弹窗：
- 表名(必填) | 类型(type，自由文本) | 说明(readme) | 可见性 | 是否公开 | 金额 | 示例数据
导入弹窗：
- 选择Excel -> 预览字段/示例 -> 填写表名 -> [导入]
- 若缺“标题”字段，提交前由前端注入空列。
```
