# 用户记忆（User Memory）API 文档

本接口覆盖 `book_user_memory` 表的完整 CRUD 能力，供“用户记忆”管理功能使用。前端管理台当前仅使用查询类接口（列表 / 详情），但后端需满足自动化或脚本写入的需求。本说明遵循项目统一的 `ApiResponse<T>` 响应格式。

## 功能概述

- 支持：列表查询（分页 / 搜索 / Level 筛选）、详情、创建、更新（重命名 / JSON 内容 / Level）、软删除
- 数据隔离：所有操作都需要传入 `userId`，仅允许访问 `user_id === userId` 且 `is_deleted = false` 的记录
- 搜索策略：默认对 `memory_name` 做 ILIKE 模糊匹配；如实现 JSON 内字段搜索，可扩展说明

## 数据模型

### 表：`book_user_memory`

| 列名 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | uuid | PK, 默认 `uuid_generate_v4()` | 记忆主键 |
| user_id | uuid | NOT NULL | 归属用户，所有接口通过 `userId` 校验 |
| memory_name | text | NOT NULL, 1~100 字符 | 记忆命名，用于展示与搜索 |
| level | text | 可空，约束 `user` \| `project` | 记忆级别（用户 / 项目） |
| memory | jsonb | 可空 | 任意键值对（形如 `{ "人设": "xx" }`） |
| is_deleted | boolean | 默认 `false` | 软删除标记 |
| created_at | timestamptz | 默认 `now()` | 创建时间 |
| updated_at | timestamptz | 默认 `now()` | 最近更新时间 |

索引建议：
- `idx_book_user_memory_user_id`
- `idx_book_user_memory_is_deleted`
- `idx_book_user_memory_level`
- （可选）GIN 索引：`CREATE INDEX idx_book_user_memory_memory_gin ON book_user_memory USING gin(memory)` 以支持 JSONB 检索

### 前端参考类型

```ts
interface UserMemoryItem {
  id: string
  memory_name: string
  level: 'user' | 'project' | null
  updated_at: string
}

interface UserMemoryDetail extends UserMemoryItem {
  user_id: string
  memory: Record<string, any> | null
  created_at: string
}
```

## 基础说明

- Base URL：`/api/user-memory`
- 鉴权：与帖子库保持一致（当前阶段不校验 JWT）；通过 `userId` 做数据隔离，需验证 UUID 格式
- 软删除：`is_deleted = true` 的记录不在列表 / 详情中返回；删除接口仅做软删除
- 统一响应：
  - 成功：`{ "success": true, "data": any }`
  - 失败：`{ "success": false, "error": "错误信息" }`

### 通用参数与校验

| 参数 | 位置 | 类型 | 必填 | 校验 | 说明 |
|------|------|------|------|------|------|
| `userId` | 查询/请求体 | string(UUID v4) | ✅ | UUID 格式 | 数据隔离依据；所有接口必须传入 |
| `id` | 查询/请求体 | string(UUID v4) | 详情/更新/删除 | UUID 格式 | 目标记录主键 |
| `level` | 查询/请求体 | `'user' \| 'project'` | 可选 | 枚举 | 记忆级别筛选 / 更新 |
| `memory_name` | 请求体 | string | 创建/rename | 长度 1~100 | 记忆名称 |
| `memory` | 请求体 | object | 创建/更新 JSON | `typeof === 'object'` 且非数组 | 任意键值对 |
| `ids` | 请求体 | string[] | 删除 | UUID 数组（1~50） | 支持批量软删除 |

错误码：统一使用 HTTP 状态码 + `ApiResponse` 错误信息，例如 `400`（参数错误）、`404`（数据不存在）

## 接口列表

### 1. 列表查询

`GET /api/user-memory?userId={uuid}&level={user|project?}&search={keyword?}&page={1}&limit={20}`

查询参数：

| 名称 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `userId` | string(UUID) | ✅ | 数据归属用户 |
| `level` | `'user' \| 'project'` | 否 | 级别筛选（缺省表示全部） |
| `search` | string | 否 | 关键词（默认对 `memory_name` ILIKE）；实现允许对 JSON 字符串值模糊匹配 |
| `page` | number | 否 | 页码，默认 1，最小 1 |
| `limit` | number | 否 | 每页条数，默认 20，最大 100 |

行为说明：
- 默认按 `updated_at DESC` 排序
- 仅返回列表所需字段（`id`、`memory_name`、`level`、`updated_at`）以减小 payload

响应示例：

```json
{
  "success": true,
  "data": {
    "items": [
      {
        "id": "1c9d6e6f-...",
        "memory_name": "人设-张三",
        "level": "user",
        "updated_at": "2025-01-18T10:20:00Z"
      }
    ],
    "total": 48,
    "page": 1,
    "limit": 20,
    "totalPages": 3
  }
}
```

错误示例：

```json
{ "success": false, "error": "缺少必填参数 userId" }
```

### 2. 获取详情

`GET /api/user-memory?id={uuid}&userId={uuid}`

说明：
- 校验 `id`、`userId` 格式
- 查询时必须附加 `is_deleted = false` 条件
- 找不到记录返回 `404`

响应示例：

```json
{
  "success": true,
  "data": {
    "id": "1c9d6e6f-...",
    "user_id": "a733e040-...",
    "memory_name": "人设-张三",
    "level": "user",
    "memory": {
      "人设": "保持阳光正面的公众号运营新人",
      "背景": "毕业 1 年，所在城市上海"
    },
    "created_at": "2025-01-01T08:00:00Z",
    "updated_at": "2025-01-18T10:20:00Z"
  }
}
```

### 3. 创建

`POST /api/user-memory`

请求体：

```json
{
  "userId": "a733e040-...",
  "memory_name": "人设-张三",
  "level": "user",
  "memory": {
    "人设": "保持阳光正面的公众号运营新人",
    "背景": "毕业 1 年，所在城市上海"
  }
}
```

校验与行为：
- `userId` 必填且为 UUID
- `memory_name` 长度 1~100，建议 trim 后再校验
- `level` 可空（传空字符串视为 `null`）或为 `user` / `project`
- `memory` 必须为对象（`typeof === 'object'` 且非数组），允许为空对象
- 插入前应确保 `is_deleted = false`

成功响应：

```json
{
  "success": true,
  "data": {
    "id": "1c9d6e6f-...",
    "created_at": "2025-01-20T02:30:00Z",
    "updated_at": "2025-01-20T02:30:00Z"
  }
}
```

错误示例：

```json
{ "success": false, "error": "memory_name 长度需在 1-100 之间" }
```

### 4. 更新

`PUT /api/user-memory`

请求体示例：

```json
{
  "userId": "a733e040-...",
  "id": "1c9d6e6f-...",
  "action": "update-json",
  "memory": {
    "人设": "保持阳光正面的公众号运营新人",
    "背景": "对 AIGC 工具感兴趣"
  },
  "merge": false
}
```

参数说明：

| 字段 | 必填 | 说明 |
|------|------|------|
| `userId` | ✅ | 目标用户 UUID |
| `id` | ✅ | 目标记录 UUID |
| `action` | ✅ | `rename` \| `update-json` \| `update-level` |
| `memory_name` | `action === 'rename'` 必填 | 新名称，1~100 字符 |
| `memory` | `action === 'update-json'` 必填 | JSON 对象 |
| `merge` | 可选（默认 false） | 仅 `action === 'update-json'` 时有效；`true` 表示浅合并（`memory = existing_memory || {}; Object.assign(memory, payload)`） |
| `level` | `action === 'update-level'` 必填 | `'user' \| 'project'` 或 `null` |

处理逻辑：
- 查询目标记录并验证归属与未被软删除
- 根据 `action` 执行对应更新，更新 `updated_at`
- 返回关键信息（`id`、`memory_name`、`level`、`updated_at`）及必要时的新 `memory`

返回示例：

```json
{
  "success": true,
  "data": {
    "id": "1c9d6e6f-...",
    "memory_name": "人设-张三",
    "level": "user",
    "updated_at": "2025-01-20T03:00:00Z"
  }
}
```

错误示例：

```json
{ "success": false, "error": "action 不支持" }
```

### 5. 删除（软删除）

`DELETE /api/user-memory`

请求体：

```json
{
  "userId": "a733e040-...",
  "ids": ["1c9d6e6f-..."]
}
```

说明：
- `ids` 为 UUID 列表，限制 1~50 条以避免一次性删除过多数据
- 执行 `UPDATE book_user_memory SET is_deleted = true, updated_at = now() WHERE id IN (...) AND user_id = userId`
- 返回成功删除的 ID 列表；未匹配到的 ID 可在 data 中返回 `failedIds` 供排查

响应示例：

```json
{
  "success": true,
  "data": {
    "deletedIds": ["1c9d6e6f-..."],
    "failedIds": []
  }
}
```

## 错误处理与日志

- 参数错误：返回 `400` + 明确的错误信息（例如 `userId 格式无效`）
- 数据不存在或已删除：返回 `404` + `记录不存在或已删除`
- 内部错误：返回 `500` + `服务器内部错误`，同时记录日志（包含请求参数、userId、action）

## 扩展建议

- 若需要针对 `memory` JSON 内的字段做模糊搜索，可考虑：
  - 预计算文本字段（如 `search_vector`）存入表中
  - 使用 PostgreSQL `jsonb_to_tsvector` 结合全文索引
- 前端可在详情页提供 JSON 展示 / 复制功能；后端建议保持字段顺序与原始存储一致

