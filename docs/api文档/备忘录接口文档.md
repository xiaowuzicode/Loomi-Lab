# 备忘录 & 品牌库（Memo Notes & Brand Library）API 文档

本接口提供"备忘录"和"品牌库"的增删改查能力，按文件夹进行组织与浏览。接口风格与项目内现有文档一致（统一 `ApiResponse<T>` 响应格式）。

## 功能概述

- 支持：创建、重命名、编辑内容（Markdown）、移动文件夹、删除（软删除）、列表与详情、分页与搜索
- 数据类型：通过 `note_type` 字段区分，`notes`（备忘录）和 `brand_info`（品牌库）
- 与"文件夹管理"保持一致的数据隔离与权限策略（通过 `userId`）
- 仅实现后端接口；管理平台当前阶段仅做展示集成

## 数据模型

### 表：`book_notes`
字段示例（参考 PRD 与数据库设计）：

```json
[
  { "column_name": "id", "data_type": "uuid", "is_nullable": "NO", "column_default": "uuid_generate_v4()" },
  { "column_name": "user_id", "data_type": "uuid", "is_nullable": "NO" },
  { "column_name": "created_user_id", "data_type": "uuid", "is_nullable": "NO" },
  { "column_name": "fold_id", "data_type": "uuid", "is_nullable": "YES" },
  { "column_name": "post_ids", "data_type": "ARRAY", "is_nullable": "YES" },
  { "column_name": "is_deleted", "data_type": "boolean", "is_nullable": "NO", "column_default": "false" },
  { "column_name": "note_name", "data_type": "text", "is_nullable": "YES" },
  { "column_name": "note", "data_type": "text", "is_nullable": "YES" },
  { "column_name": "share_url", "data_type": "text", "is_nullable": "YES" },
  { "column_name": "source", "data_type": "text", "is_nullable": "YES" },
  { "column_name": "created_at", "data_type": "timestamptz", "is_nullable": "NO", "column_default": "now()" },
  { "column_name": "updated_at", "data_type": "timestamptz", "is_nullable": "NO", "column_default": "now()" }
]
```

索引建议：
- `idx_book_notes_user_id`
- `idx_book_notes_fold_id`
- `idx_book_notes_is_deleted`
- （可选）全文检索扩展：后续引入

### 前端类型（参考）

```ts
interface MemoNote {
  id: string
  userId: string
  createdUserId: string
  foldId: string | null
  noteName: string
  note: string // markdown
  isDeleted: boolean
  createdAt: string
  updatedAt: string
}
```

## 基础说明

- Base URL：`/api/memo-notes`
- 鉴权：平台 JWT（`Authorization: Bearer <token>`），并通过 `userId` 参数做数据隔离
- 约束：
  - `note_name`：1–100 字符
  - `note`：建议 ≤ 200KB
  - `fold_id` 可为空（表示未归档）
  - 软删除：`is_deleted = true` 的记录默认不出现在列表

### 参数与权限

| 参数 | 类型 | 位置 | 必填 | 说明 |
|------|------|------|------|------|
| `userId` | string (UUID) | 查询/请求体 | ✅ | 数据隔离与权限依据；只允许操作 `user_id === userId` 的记录 |
| `id` | string (UUID) | 查询/请求体 | 详情/更新/删除必填 | 笔记主键 |
| `foldId/fold_id` | string (UUID) or null | 查询/请求体 | 可选 | 文件夹ID；为空表示未分组 |

错误响应统一格式：

```json
{ "success": false, "error": "错误信息" }
```

## 接口列表

### 1. 列表查询（按文件夹筛选 + 搜索 + 分页）

GET `/api/memo-notes?userId={userId}&noteType={noteType}&foldId={foldId?}&search={kw?}&page={1}&limit={20}`

查询参数：

| 名称 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `userId` | string | ✅ | 用户UUID |
| `noteType` | string | ✅ | 数据类型：`notes`（备忘录）或 `brand_info`（品牌库） |
| `foldId` | string or `null` | 否 | 文件夹ID，缺省表示所有/未过滤 |
| `search` | string | 否 | 关键词（对 `note_name`/`note` 进行 ILIKE 模糊） |
| `page` | number | 否 | 页码，默认 1 |
| `limit` | number | 否 | 每页条数，默认 20，最大 100 |

响应示例：

```json
{
  "success": true,
  "data": {
    "items": [
      { "id": "4db7...", "note_name": "周报模板", "fold_id": null, "updated_at": "2025-01-20T10:30:00Z" }
    ],
    "total": 123,
    "page": 1,
    "limit": 20,
    "totalPages": 7
  }
}
```

说明：
- 仅返回用于列表所需的精简字段（`id`、`note_name`、`fold_id`、`updated_at`）。
- `noteType=notes` 对应文件夹类型 `type=notes`；`noteType=brand_info` 对应文件夹类型 `type=brand_info`。

### 2. 获取详情

GET `/api/memo-notes?id={noteId}&userId={userId}`

响应示例：

```json
{
  "success": true,
  "data": {
    "id": "4db7...",
    "user_id": "0000...",
    "created_user_id": "0000...",
    "fold_id": null,
    "note_name": "周报模板",
    "note": "# 标题\n...",
    "created_at": "2025-01-18T08:00:00Z",
    "updated_at": "2025-01-20T10:30:00Z"
  }
}
```

### 3. 创建

POST `/api/memo-notes`

请求体：

```json
{
  "userId": "00000000-0000-4000-8000-000000000001",
  "note_type": "notes",
  "note_name": "新的笔记",
  "note": "# Markdown 内容",
  "fold_id": null
}
```

响应：`{ success: true, data: { id, created_at, updated_at } }`

校验：
- `note_type` 必填，仅允许 `notes` 或 `brand_info`
- `note_name` 必填，1–100；`note` 可为空字符串；`fold_id` 可空

### 4. 更新（重命名 / 内容 / 移动）

PUT `/api/memo-notes`

三种 `action`：

```json
// 4.1 重命名
{ "userId": "{uuid}", "id": "{noteId}", "action": "rename", "note_name": "新名称" }

// 4.2 更新内容
{ "userId": "{uuid}", "id": "{noteId}", "action": "update-content", "note": "# 新版内容" }

// 4.3 移动文件夹
{ "userId": "{uuid}", "id": "{noteId}", "action": "move", "fold_id": "{uuid|null}" }
```

响应示例（基于服务端实际返回字段）：

```json
// 4.1 重命名（返回 id、note_name、updated_at）
{
  "success": true,
  "data": {
    "id": "9f1b0c35-2a33-4b4f-9b2b-2d1e1a3f3a0f",
    "note_name": "新名称",
    "updated_at": "2025-09-17T09:40:12.345Z"
  }
}

// 4.2 更新内容（返回 id、updated_at）
{
  "success": true,
  "data": {
    "id": "9f1b0c35-2a33-4b4f-9b2b-2d1e1a3f3a0f",
    "updated_at": "2025-09-17T09:41:58.001Z"
  }
}

// 4.3 移动文件夹（返回 id、fold_id、updated_at）
{
  "success": true,
  "data": {
    "id": "9f1b0c35-2a33-4b4f-9b2b-2d1e1a3f3a0f",
    "fold_id": "a1a2a3a4-0000-4000-8000-000000000000", // 或 null 表示移出文件夹
    "updated_at": "2025-09-17T09:42:30.789Z"
  }
}
```

### 5. 删除（软删除，支持批量）

DELETE `/api/memo-notes`

请求体：

```json
{ "userId": "{uuid}", "ids": ["{id1}", "{id2}"] }
```

响应：

```json
{ "success": true, "data": { "deletedIds": ["{id1}", "{id2}"] } }
```

## 校验与错误码

- 400：参数不合法（`userId`/`id` 非UUID、`note_name` 长度不符等）
- 401：未认证（缺少/无效 JWT）
- 403：无权限（`userId` 与记录不匹配）
- 404：记录不存在
- 500：服务器内部错误

## 性能说明

- 列表查询分页 + 精简字段，避免返回全文 Markdown
- 利用 `user_id`/`fold_id`/`is_deleted` 索引
- 搜索使用 ILIKE 模糊；后续可扩展全文检索

## 备注

- 与“文件夹管理”联动：`fold_id` 对应 `/api/memo-folders` 树节点；前端可在展开某节点时按 `foldId` 拉取其下笔记
- 当前阶段管理平台仅做展示集成；后续可扩展“收藏/置顶/标签”等附加字段与接口

