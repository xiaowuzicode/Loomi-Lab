# å¸–å­åº“ï¼ˆPosts Libraryï¼‰API æ–‡æ¡£

æœ¬æ¥å£ç”¨äºåœ¨ç®¡ç†ç«¯æŒ‰ç”¨æˆ·ç»´åº¦æµè§ˆâ€œå¸–å­åº“â€æ•°æ®ã€‚æ•°æ®æ¥æºä¸º `knowledge_base` è¡¨ï¼ˆæŒ‰ç”¨æˆ·IDè¿‡æ»¤ï¼‰çš„è®°å½•ï¼Œæ–‡ä»¶å¤¹ç»“æ„å¤ç”¨ `book_folds`ï¼ˆ`type = 'å¸–å­'`ï¼‰ã€‚å½“å‰ç‰ˆæœ¬ä»…æä¾›æŸ¥çœ‹ã€æ£€ç´¢ã€åˆ é™¤ä¸å‘é‡åŒ–èƒ½åŠ›ï¼Œä¸æ”¯æŒæ‰‹å·¥æ–°å¢/ä¿®æ”¹ã€‚

## æ•°æ®æ¨¡å‹æ¦‚è§ˆ

### knowledge_baseï¼ˆå…³é”®å­—æ®µï¼‰
| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| id | uuid | ä¸»é”® |
| user_id | uuid | æ‰€å±ç”¨æˆ·ID |
| fold_id | uuid/null | æ‰€å±æ–‡ä»¶å¤¹ï¼Œnull ä»£è¡¨â€œæœªåˆ†ç»„â€ |
| title | text | å¸–å­æ ‡é¢˜ï¼ˆåŸºç¡€å­—æ®µï¼‰ |
| content | text | å¸–å­æ­£æ–‡ï¼ˆåŸºç¡€å­—æ®µï¼‰ |
| content_type | text | æ¥æºå¹³å°/ç±»å‹ï¼ˆå¯é€‰å­—æ®µï¼Œä¸å‚ä¸è¿‡æ»¤ï¼‰ |
| meta_data | jsonb | å¸–å­æ‰©å±•ä¿¡æ¯ï¼ˆè¯¦è§ä¸‹æ–‡ï¼‰ |
| embedding | vector/null | å¸–å­å‘é‡è¡¨ç¤ºï¼ˆ1536 ç»´ï¼Œç©ºè¡¨ç¤ºå¾…å‘é‡åŒ–ï¼‰ |
| created_at/updated_at | timestamptz | åˆ›å»º/æ›´æ–°æ—¶é—´ |

### meta_data ç¤ºä¾‹
```json
{
  "tags": ["#åŠªåŠ›æˆä¸ºæ›´å¥½çš„è‡ªå·±", "#æœ‹å‹åœˆæ–‡æ¡ˆ"],
  "title": "é€‚åˆç²¾è‡´å¥³å­©çš„æ—¥å¸¸æ–‡æ¡ˆ",
  "author": { "name": "èåœä¹Ÿå®³ç¾", "avatar": "https://..." },
  "content": "1. æˆ‘çš„è®¡åˆ’æ˜¯ä¸€ç›´çˆ±è‡ªå·±...",
  "comments": [
    { "time": "2024-03-27", "likes": "6", "author": "å°æŸ æª¬ğŸ‹", "content": "5" }
  ],
  "mediaList": [
    { "url": "https://...", "type": "image" }
  ],
  "interactions": { "likes": "3550", "collects": "1881", "comments": "74" },
  "publishTime": "ç¼–è¾‘äº 2024-03-01",
  "extractedAt": "2025-09-12T13:51:02.792Z"
}
```

## æ¥å£åˆ—è¡¨

### 1. è·å–å¸–å­åˆ—è¡¨
GET `/api/posts-library?userId={userId}&foldId={foldId?}&search={kw?}&page={1}&limit={20}`

| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| userId | string | âœ… | ç”¨æˆ·IDï¼ˆUUIDï¼‰ã€‚ä»…æŸ¥è¯¢è¯¥ç”¨æˆ·çš„æ•°æ® |
| foldId | string/null | âŒ | æ–‡ä»¶å¤¹IDï¼ˆUUIDï¼‰ï¼›`null` / `none` è¡¨ç¤ºâ€œæœªåˆ†ç»„â€ï¼›ä¸ä¼ è¡¨ç¤ºâ€œä¸è¿‡æ»¤â€ |
| search | string | âŒ | å…³é”®å­—ï¼Œæ¨¡ç³ŠåŒ¹é… `title/content/meta.title/meta.content` |
| page | number | âŒ | é¡µç ï¼Œé»˜è®¤ 1ï¼Œæœ€å°å€¼ 1 |
| limit | number | âŒ | æ¯é¡µæ•°é‡ï¼Œé»˜è®¤ 20ï¼ŒèŒƒå›´ 1â€“100 |

å“åº”ï¼ˆæˆåŠŸï¼‰ï¼š
```json
{
  "success": true,
  "data": {
    "items": [
      {
        "id": "uuid",
        "title": "å¸–å­æ ‡é¢˜ï¼ˆmeta.title ä¼˜å…ˆï¼‰",
        "fold_id": "uuid/null",
        "updated_at": "2024-09-22T12:00:00Z"
      }
    ],
    "page": 1,
    "limit": 20,
    "total": 120,
    "totalPages": 6
  }
}
```

è¯´æ˜ï¼š
- æœ¬æ¥å£å¿½ç•¥ `type` å‚æ•°ï¼ˆä»£ç æœªè¯»å–ï¼‰ã€‚æ–‡ä»¶å¤¹æ ‘è¯·è°ƒç”¨ `/api/memo-folders` å¹¶ä¼  `type=posts`ã€‚
- `foldId` ä¸ºç©ºå­—ç¬¦ä¸²/çœç•¥æ—¶ä¸æŒ‰æ–‡ä»¶å¤¹è¿‡æ»¤ï¼›ä¼  `null`ï¼ˆå­—ç¬¦ä¸²ï¼‰æ—¶åŒ¹é…æœªåˆ†ç»„ã€‚
- æœç´¢ä½¿ç”¨ OR æ¡ä»¶ï¼š`title`ã€`content`ã€`meta_data->title`ã€`meta_data->content`ã€‚

### 2. è·å–å¸–å­è¯¦æƒ…
GET `/api/posts-library?id={id}&userId={userId}`

| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| id | string | âœ… | å¸–å­IDï¼ˆUUIDï¼‰ |
| userId | string | âœ… | ç”¨æˆ·IDï¼ˆUUIDï¼‰ |

å“åº”ï¼ˆæˆåŠŸï¼‰ï¼š
```json
{
  "success": true,
  "data": {
    "id": "uuid",
    "user_id": "uuid",
    "fold_id": "uuid/null",
    "title": "åŸºç¡€æ ‡é¢˜",
    "content": "åŸºç¡€æ­£æ–‡",
    "meta": {
      "title": "é€‚åˆç²¾è‡´å¥³å­©çš„æ—¥å¸¸æ–‡æ¡ˆ",
      "tags": ["#åŠªåŠ›æˆä¸ºæ›´å¥½çš„è‡ªå·±"],
      "author": { "name": "èåœä¹Ÿå®³ç¾", "avatar": "https://..." },
      "content": "1. æˆ‘çš„è®¡åˆ’æ˜¯ä¸€ç›´çˆ±è‡ªå·±...",
      "comments": [...],
      "mediaList": [...],
      "interactions": { "likes": "3550", "collects": "1881", "comments": "74" },
      "publishTime": "ç¼–è¾‘äº 2024-03-01",
      "extractedAt": "2025-09-12T13:51:02.792Z"
    },
    "created_at": "2024-09-20T08:00:00Z",
    "updated_at": "2024-09-22T12:00:00Z"
  }
}
```

å¤‡æ³¨ï¼š`meta` å­—æ®µä¸º JSON å¯¹è±¡ï¼ˆè‡ªåŠ¨è§£æï¼‰ï¼›è‹¥åŸå§‹æ•°æ®æ˜¯å­—ç¬¦ä¸²ä¼šåœ¨å“åº”ä¸­è½¬æ¢ä¸ºå¯¹è±¡ã€‚

### 3. æ‰¹é‡åˆ é™¤å¸–å­
DELETE `/api/posts-library`

è¯·æ±‚ä½“ï¼š
```json
{ "userId": "uuid", "ids": ["uuid1", "uuid2"] }
```

å“åº”ï¼š
```json
{ "success": true, "data": { "deletedIds": ["uuid1", "uuid2"] } }
```

è¯´æ˜ï¼š
- ä»…æ”¯æŒè½¯/ç¡¬åˆ é™¤å½“å‰ç”¨æˆ·çš„ `content_type = 'posts'` è®°å½•ã€‚
- `ids` å¿…é¡»ä¸º UUID æ•°ç»„ï¼Œè‡³å°‘åŒ…å« 1 é¡¹ã€‚

## ç»Ÿä¸€é”™è¯¯å“åº”
```json
{ "success": false, "error": "é”™è¯¯æè¿°" }
```

å¸¸è§é”™è¯¯ï¼š
- `400`ï¼šç¼ºå°‘/éæ³•å‚æ•°ï¼ˆå¦‚ `userId`ã€`id`ã€`foldId` æ ¼å¼é”™è¯¯ï¼‰ã€‚
- `404`ï¼šç›®æ ‡è®°å½•ä¸å­˜åœ¨æˆ–ä¸å±äºè¯¥ç”¨æˆ·ã€‚
- `500`ï¼šæœåŠ¡å™¨å†…éƒ¨é”™è¯¯ï¼ˆSupabase æŸ¥è¯¢å¼‚å¸¸ç­‰ï¼‰ã€‚

## ä¸æ–‡ä»¶å¤¹æ¥å£çš„å…³ç³»
- æ–‡ä»¶å¤¹æ ‘ä»ä½¿ç”¨ `/api/memo-folders`ï¼Œè°ƒç”¨æ—¶ `type=posts`ï¼ˆåœ¨åç«¯æ˜ å°„ä¸º `book_folds.type = 'å¸–å­'`ï¼‰ã€‚
- â€œæœªåˆ†ç»„â€å¸–å­é€šè¿‡ `fold_id = null` åŒºåˆ†ã€‚
- é¡µé¢ä»…æ‰§è¡Œè¯»å–ä¸åˆ é™¤æ“ä½œï¼›è‹¥åç»­éœ€è¦æ–°å¢/ç¼–è¾‘ï¼Œè¯·å¦è¡Œæ‰©å±•æ¥å£ã€‚

### 4. æŸ¥è¯¢å¾…å‘é‡åŒ–å¸–å­
GET `/api/posts-library/vectorization/pending?userId={userId}&page={1}&limit={50}`

| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| userId | string | âœ… | ç”¨æˆ·IDï¼ˆUUIDï¼‰ï¼Œé™å®šæŸ¥è¯¢èŒƒå›´ |
| page | number | âŒ | é¡µç ï¼Œé»˜è®¤ 1ï¼Œæœ€å°å€¼ 1 |
| limit | number | âŒ | æ¯é¡µæ•°é‡ï¼Œé»˜è®¤ 50ï¼ŒèŒƒå›´ 1â€“200 |

å“åº”ï¼ˆæˆåŠŸï¼‰ï¼š
```json
{
  "success": true,
  "data": {
    "items": [
      {
        "id": "uuid",
        "created_at": "2024-09-20T08:00:00Z",
        "updated_at": "2024-09-22T12:00:00Z"
      }
    ],
    "total": 12,
    "page": 1,
    "limit": 50,
    "totalPages": 1
  }
}
```

è¯´æ˜ï¼š
- ä»…è¿”å› `embedding IS NULL` çš„è®°å½•ï¼Œç”¨äºåç»­æ‰¹é‡å‘é‡åŒ–ã€‚
- è¿”å›å­—æ®µä»…ä¿ç•™ `id`ã€`created_at`ã€`updated_at`ï¼Œç”¨äºå±•ç¤ºä¸åç»­æ‰¹é‡ä»»åŠ¡å®šä½ï¼›å‘é‡åŒ–æ­¥éª¤ä¼šåœ¨åå°é‡æ–°æ‹‰å–å®Œæ•´å†…å®¹ã€‚

### 5. æ‰¹é‡å‘é‡åŒ–å¸–å­
POST `/api/posts-library/vectorization`

è¯·æ±‚ä½“ï¼š
```json
{
  "userId": "uuid",
  "ids": ["uuid1", "uuid2"],
  "concurrency": 5
}
```

| å­—æ®µ | å¿…å¡« | è¯´æ˜ |
|------|------|------|
| userId | âœ… | é™å®šåªå¤„ç†è¯¥ç”¨æˆ·çš„å¸–å­ |
| ids | âŒ | æŒ‡å®šå¾…å‘é‡åŒ–çš„å¸–å­IDæ•°ç»„ï¼›ä¸ºç©ºæˆ–ç¼ºçœæ—¶é»˜è®¤å¤„ç†è¯¥ç”¨æˆ·æ‰€æœ‰ `embedding IS NULL` çš„å¸–å­ |
| concurrency | âŒ | å¹¶è¡Œåº¦ï¼ˆé»˜è®¤ 5ï¼‰ï¼Œé™åˆ¶åŒæ—¶è¿›è¡Œçš„ OpenAI è¯·æ±‚æ•°é‡ï¼Œé˜²æ­¢è§¦å‘é™æµ |

å“åº”ï¼ˆæˆåŠŸï¼‰ï¼š
```json
{
  "success": true,
  "data": {
    "processed": 10,
    "succeeded": 8,
    "failed": 2,
    "results": [
      { "id": "uuid1", "status": "success" },
      { "id": "uuid2", "status": "failed", "error": "OpenAI: rate_limit" }
    ]
  },
  "message": "å‘é‡åŒ–å®Œæˆ"
}
```

å‘é‡åŒ–è§„åˆ™ï¼š
- æ¨¡å‹æ²¿ç”¨â€œç­–ç•¥åº“â€æ‰€ä½¿ç”¨çš„ OpenAI Embedding æ¨¡å‹ï¼ˆé»˜è®¤ `text-embedding-3-small`ï¼‰ã€‚
- åˆ†åˆ«è·å– title/content çš„ embeddingï¼Œéšåè®¡ç®— `0.7 * Emb(title) + 0.3 * Emb(content)` å¹¶åšå½’ä¸€åŒ–åå†™å›ã€‚
- æˆåŠŸåæ›´æ–° `knowledge_base.embedding`ï¼›å¤±è´¥æ—¶å¯è¡¥å……é”™è¯¯æ—¥å¿—ï¼ˆå¦‚å†™å…¥ `meta_data.vectorize_error`ï¼‰ä»¥ä¾¿æ’æŸ¥ã€‚
- æ‰¹é‡å¤„ç†éœ€ä»¥ç”¨æˆ·ä¸ºç•Œé™ï¼Œé¿å…è·¨ç”¨æˆ·è®°å½•è¢«æ›´æ–°ã€‚

### 6. ç›¸ä¼¼å¸–å­æ£€ç´¢
POST `/api/posts-library/vector-search`

è¯·æ±‚ä½“ï¼š
```json
{
  "userId": "uuid",
  "query": "å¼€æ˜¥ç©¿æ­æ¨è",
  "topK": 3,
  "minScore": 0.2
}
```

| å­—æ®µ | å¿…å¡« | è¯´æ˜ |
|------|------|------|
| userId | âœ… | ç”¨æˆ·IDï¼ˆUUIDï¼‰ï¼Œåªæ£€ç´¢è¯¥ç”¨æˆ·çš„å¸–å­ |
| query | âœ… | æŸ¥è¯¢æ–‡æœ¬ï¼Œå°†é€šè¿‡åŒæ¬¾æ¨¡å‹å‘é‡åŒ– |
| topK | âŒ | è¿”å›æ•°é‡ï¼Œé»˜è®¤ 3ï¼Œä¸Šé™ 10 |
| minScore | âŒ | æœ€å°ç›¸ä¼¼åº¦é˜ˆå€¼ï¼ˆä½™å¼¦ï¼‰ï¼Œé»˜è®¤ 0ï¼Œè¿‡æ»¤ä½ç›¸ä¼¼åº¦ç»“æœ |

å“åº”ï¼ˆæˆåŠŸï¼‰ï¼š
```json
{
  "success": true,
  "data": {
    "results": [
      {
        "id": "uuid",
        "user_id": "uuid",
        "title": "æ˜¥æ—¥å¤å¤ç©¿æ­",
        "content_type": "xiaohongshu",
        "content": "ä¸»è¦å†…å®¹...",
        "author": "@å¯ä¹åŠ å†°",
        "tags": ["æ˜¥å­£", "ç©¿æ­"],
        "score": 0.84
      }
    ]
  }
}
```

è¯´æ˜ï¼š
- æ£€ç´¢é€»è¾‘ä½¿ç”¨æ•°æ®åº“å‘é‡ç´¢å¼• `knowledge_base_embedding_idx`ï¼ŒæŒ‰ä½™å¼¦ç›¸ä¼¼åº¦æ’åºã€‚
- ä»…è¿”å› `embedding` éç©ºçš„å¸–å­ï¼ŒæŒ‰å¾—åˆ†é™åºæˆªå– `topK` æ¡ã€‚
- è‹¥æ— æ»¡è¶³é˜ˆå€¼çš„ç»“æœï¼Œè¿”å›ç©ºæ•°ç»„ã€‚

