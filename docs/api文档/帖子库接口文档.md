# 帖子库（Posts Library）API 文档

本接口用于在管理端按用户维度浏览“帖子库”数据。数据来源为 `knowledge_base` 表（按用户ID过滤）的记录，文件夹结构复用 `book_folds`（`type = '帖子'`）。当前版本仅提供查看与删除能力，不支持新增/修改。

## 数据模型概览

### knowledge_base（关键字段）
| 字段 | 类型 | 说明 |
|------|------|------|
| id | uuid | 主键 |
| user_id | uuid | 所属用户ID |
| fold_id | uuid/null | 所属文件夹，null 代表“未分组” |
| title | text | 帖子标题（基础字段） |
| content | text | 帖子正文（基础字段） |
| content_type | text | 来源平台/类型（可选字段，不参与过滤） |
| meta_data | jsonb | 帖子扩展信息（详见下文） |
| created_at/updated_at | timestamptz | 创建/更新时间 |

### meta_data 示例
```json
{
  "tags": ["#努力成为更好的自己", "#朋友圈文案"],
  "title": "适合精致女孩的日常文案",
  "author": { "name": "萝卜也害羞", "avatar": "https://..." },
  "content": "1. 我的计划是一直爱自己...",
  "comments": [
    { "time": "2024-03-27", "likes": "6", "author": "小柠檬🍋", "content": "5" }
  ],
  "mediaList": [
    { "url": "https://...", "type": "image" }
  ],
  "interactions": { "likes": "3550", "collects": "1881", "comments": "74" },
  "publishTime": "编辑于 2024-03-01",
  "extractedAt": "2025-09-12T13:51:02.792Z"
}
```

## 接口列表

### 1. 获取帖子列表
GET `/api/posts-library?userId={userId}&type={type}&foldId={foldId?}&search={kw?}&page={1}&limit={20}`

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| userId | string | ✅ | 用户ID（UUID）。仅查询该用户的数据 |
| type | string | ✅ | 文件夹类型；`memo-folders` 页面传入 `posts`（与 `book_folds.type` 对应中文“帖子”） |
| foldId | string/null | ❌ | 文件夹ID（UUID）；`null` / `none` 表示“未分组”；不传表示“不过滤” |
| search | string | ❌ | 关键字，模糊匹配 `title/content/meta.title/meta.content` |
| page | number | ❌ | 页码，默认 1，最小值 1 |
| limit | number | ❌ | 每页数量，默认 20，范围 1–100 |

响应（成功）：
```json
{
  "success": true,
  "data": {
    "items": [
      {
        "id": "uuid",
        "title": "帖子标题（meta.title 优先）",
        "fold_id": "uuid/null",
        "updated_at": "2024-09-22T12:00:00Z"
      }
    ],
    "page": 1,
    "limit": 20,
    "total": 120,
    "totalPages": 6
  }
}
```

说明：
- `type` 仅用于匹配 `book_folds` 文件夹树（后端映射为 `type="帖子"`）。
- `foldId` 为空字符串/省略时不按文件夹过滤；传 `null`（字符串）时匹配未分组。
- 搜索使用 OR 条件：`title`、`content`、`meta_data->title`、`meta_data->content`。

### 2. 获取帖子详情
GET `/api/posts-library?id={id}&userId={userId}`

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| id | string | ✅ | 帖子ID（UUID） |
| userId | string | ✅ | 用户ID（UUID） |

响应（成功）：
```json
{
  "success": true,
  "data": {
    "id": "uuid",
    "user_id": "uuid",
    "fold_id": "uuid/null",
    "title": "基础标题",
    "content": "基础正文",
    "meta": {
      "title": "适合精致女孩的日常文案",
      "tags": ["#努力成为更好的自己"],
      "author": { "name": "萝卜也害羞", "avatar": "https://..." },
      "content": "1. 我的计划是一直爱自己...",
      "comments": [...],
      "mediaList": [...],
      "interactions": { "likes": "3550", "collects": "1881", "comments": "74" },
      "publishTime": "编辑于 2024-03-01",
      "extractedAt": "2025-09-12T13:51:02.792Z"
    },
    "created_at": "2024-09-20T08:00:00Z",
    "updated_at": "2024-09-22T12:00:00Z"
  }
}
```

备注：`meta` 字段为 JSON 对象（自动解析）；若原始数据是字符串会在响应中转换为对象。

### 3. 批量删除帖子
DELETE `/api/posts-library`

请求体：
```json
{ "userId": "uuid", "ids": ["uuid1", "uuid2"] }
```

响应：
```json
{ "success": true, "data": { "deletedIds": ["uuid1", "uuid2"] } }
```

说明：
- 仅支持软/硬删除当前用户的 `content_type = 'posts'` 记录。
- `ids` 必须为 UUID 数组，至少包含 1 项。

## 统一错误响应
```json
{ "success": false, "error": "错误描述" }
```

常见错误：
- `400`：缺少/非法参数（如 `userId`、`id`、`foldId` 格式错误）。
- `404`：目标记录不存在或不属于该用户。
- `500`：服务器内部错误（Supabase 查询异常等）。

## 与文件夹接口的关系
- 文件夹树仍使用 `/api/memo-folders`，调用时 `type=posts`（在后端映射为 `book_folds.type = '帖子'`）。
- “未分组”帖子通过 `fold_id = null` 区分。
- 页面仅执行读取与删除操作；若后续需要新增/编辑，请另行扩展接口。
