# 帖子库（Posts Library）API 文档

本接口用于在管理端按用户维度浏览“帖子库”数据。数据来源为 `knowledge_base` 表（按用户ID过滤）的记录，文件夹结构复用 `book_folds`（`type = 'hot_content'`）。当前版本仅提供查看、检索、删除与向量化能力，不支持手工新增/修改。

## 数据模型概览

### knowledge_base（关键字段）
| 字段 | 类型 | 说明 |
|------|------|------|
| id | uuid | 主键 |
| user_id | uuid | 所属用户ID |
| fold_id | uuid/null | 所属文件夹，null 代表“未分组” |
| title | text | 帖子标题（基础字段） |
| content | text | 帖子正文（基础字段） |
| content_type | text | 来源平台/类型（可选字段，不参与过滤） |
| meta_data | jsonb | 帖子扩展信息（详见下文） |
| embedding | vector/null | 帖子向量表示（1536 维，空表示待向量化） |
| created_at/updated_at | timestamptz | 创建/更新时间 |

### meta_data 示例
```json
{
  "tags": ["#努力成为更好的自己", "#朋友圈文案"],
  "title": "适合精致女孩的日常文案",
  "author": { "name": "萝卜也害羞", "avatar": "https://..." },
  "content": "1. 我的计划是一直爱自己...",
  "comments": [
    { "time": "2024-03-27", "likes": "6", "author": "小柠檬🍋", "content": "5" }
  ],
  "mediaList": [
    { "url": "https://...", "type": "image" }
  ],
  "interactions": { "likes": "3550", "collects": "1881", "comments": "74" },
  "publishTime": "编辑于 2024-03-01",
  "extractedAt": "2025-09-12T13:51:02.792Z"
}
```

## 接口列表

### 1. 获取帖子列表
GET `/api/posts-library?userId={userId}&foldId={foldId?}&search={kw?}&page={1}&limit={20}`

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| userId | string | ✅ | 用户ID（UUID）。仅查询该用户的数据 |
| foldId | string/null | ❌ | 文件夹ID（UUID）；`null` / `none` 表示“未分组”；不传表示“不过滤” |
| search | string | ❌ | 关键字，模糊匹配 `title/content/meta.title/meta.content` |
| page | number | ❌ | 页码，默认 1，最小值 1 |
| limit | number | ❌ | 每页数量，默认 20，范围 1–100 |

响应（成功）：
```json
{
  "success": true,
  "data": {
    "items": [
      {
        "id": "uuid",
        "title": "帖子标题（meta.title 优先）",
        "fold_id": "uuid/null",
        "updated_at": "2024-09-22T12:00:00Z"
      }
    ],
    "page": 1,
    "limit": 20,
    "total": 120,
    "totalPages": 6
  }
}
```

说明：
- 本接口忽略 `type` 参数（代码未读取）。文件夹列表请调用 `/api/memo-folders` 并传 `type=hot_content`。
- `foldId` 来自 `book_folds.fold_structure` 的扁平数组中每项的 `id` 字段（示例项：`{ id, name, created_at, is_default, updated_at }`）。
- `foldId` 为空字符串/省略时不按文件夹过滤；传 `null`（字符串）时匹配未分组。
- 搜索使用 OR 条件：`title`、`content`、`meta_data->title`、`meta_data->content`。

### 2. 获取帖子详情
GET `/api/posts-library?id={id}&userId={userId}`

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| id | string | ✅ | 帖子ID（UUID） |
| userId | string | ✅ | 用户ID（UUID） |

响应（成功）：
```json
{
  "success": true,
  "data": {
    "id": "uuid",
    "user_id": "uuid",
    "fold_id": "uuid/null",
    "title": "基础标题",
    "content": "基础正文",
    "meta": {
      "title": "适合精致女孩的日常文案",
      "tags": ["#努力成为更好的自己"],
      "author": { "name": "萝卜也害羞", "avatar": "https://..." },
      "content": "1. 我的计划是一直爱自己...",
      "comments": [...],
      "mediaList": [...],
      "interactions": { "likes": "3550", "collects": "1881", "comments": "74" },
      "publishTime": "编辑于 2024-03-01",
      "extractedAt": "2025-09-12T13:51:02.792Z"
    },
    "created_at": "2024-09-20T08:00:00Z",
    "updated_at": "2024-09-22T12:00:00Z"
  }
}
```

备注：`meta` 字段为 JSON 对象（自动解析）；若原始数据是字符串会在响应中转换为对象。

### 3. 批量删除帖子
DELETE `/api/posts-library`

请求体：
```json
{ "userId": "uuid", "ids": ["uuid1", "uuid2"] }
```

响应：
```json
{ "success": true, "data": { "deletedIds": ["uuid1", "uuid2"] } }
```

说明：
- 仅支持软/硬删除当前用户的 `content_type = 'posts'` 记录。
- `ids` 必须为 UUID 数组，至少包含 1 项。

## 统一错误响应
```json
{ "success": false, "error": "错误描述" }
```

常见错误：
- `400`：缺少/非法参数（如 `userId`、`id`、`foldId` 格式错误）。
- `404`：目标记录不存在或不属于该用户。
- `500`：服务器内部错误（Supabase 查询异常等）。

## 与文件夹接口的关系
- 文件夹列表使用 `/api/memo-folders`，调用时 `type=hot_content`（`book_folds.type = 'hot_content'`）。
- `fold_structure` 现为扁平数组，`foldId` 取自其中每项的 `id` 字段。
- “未分组”帖子通过 `fold_id = null` 区分。
- 页面仅执行读取与删除操作；若后续需要新增/编辑，请另行扩展接口。

### 4. 查询待向量化帖子
GET `/api/posts-library/vectorization/pending?userId={userId}&page={1}&limit={50}`

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| userId | string | ✅ | 用户ID（UUID），限定查询范围 |
| page | number | ❌ | 页码，默认 1，最小值 1 |
| limit | number | ❌ | 每页数量，默认 50，范围 1–200 |

响应（成功）：
```json
{
  "success": true,
  "data": {
    "items": [
      {
        "id": "uuid",
        "created_at": "2024-09-20T08:00:00Z",
        "updated_at": "2024-09-22T12:00:00Z"
      }
    ],
    "total": 12,
    "page": 1,
    "limit": 50,
    "totalPages": 1
  }
}
```

说明：
- 仅返回 `embedding IS NULL` 的记录，用于后续批量向量化。
- 返回字段仅保留 `id`、`created_at`、`updated_at`，用于展示与后续批量任务定位；向量化步骤会在后台重新拉取完整内容。

### 5. 批量向量化帖子
POST `/api/posts-library/vectorization`

请求体：
```json
{
  "userId": "uuid",
  "ids": ["uuid1", "uuid2"],
  "concurrency": 5,
  "force": false
}
```

| 字段 | 必填 | 说明 |
|------|------|------|
| userId | ✅ | 限定只处理该用户的帖子 |
| ids | ❌ | 指定待向量化的帖子ID数组；为空或缺省时默认处理该用户所有 `embedding IS NULL` 的帖子 |
| concurrency | ❌ | 并行度（默认 5），限制同时进行的 OpenAI 请求数量，防止触发限流 |
| force | ❌ | 是否强制重算已存在的向量（true 时覆盖原 embedding） |

响应（成功）：
```json
{
  "success": true,
  "data": {
    "processed": 10,
    "succeeded": 8,
    "failed": 2,
    "results": [
      { "id": "uuid1", "status": "success" },
      { "id": "uuid2", "status": "failed", "error": "OpenAI: rate_limit" }
    ]
  },
  "message": "向量化完成"
}
```

向量化规则：
- 模型沿用“策略库”所使用的 OpenAI Embedding 模型（默认 `text-embedding-3-small`）。
- 分别获取 title/content 的 embedding，随后计算 `0.7 * Emb(title) + 0.3 * Emb(content)` 并做归一化后写回。
- 成功后更新 `knowledge_base.embedding`；失败时可补充错误日志（如写入 `meta_data.vectorize_error`）以便排查。
- 批量处理需以用户为界限，避免跨用户记录被更新。
 - `force` 仅在提供 `ids` 时生效：当 `force=true` 且传入 `ids` 时，即便目标记录已有向量也会重算并覆盖；未提供 `ids` 时，始终仅处理 `embedding IS NULL` 的记录，忽略 `force`。

### 6. 相似帖子检索
POST `/api/posts-library/vector-search`

请求体：
```json
{
  "userId": "uuid",
  "query": "开春穿搭推荐 -> 小个子穿搭 -> 春季休闲",
  "topK": 3,
  "minScore": 0.2,
  "foldId": "uuid|null|none",
  "days": 7
}
```

| 字段 | 必填 | 说明 |
|------|------|------|
| userId | ✅ | 用户ID（UUID），只检索该用户的帖子 |
| query | ✅ | 查询文本，支持多层：使用 `->` 分隔，如 `q1 -> q2 -> q3`，最多 3 层；只有一层时与原行为一致 |
| topK | ❌ | 返回数量，默认 3，上限 10 |
| minScore | ❌ | 最小相似度阈值（余弦），默认 0，过滤低相似度结果 |
| foldId | ❌ | 指定文件夹过滤：传 `uuid`（取自 `/api/memo-folders?type=hot_content` 的 `fold_structure[].id`）仅检索该文件夹；传 `null`/`none` 仅检索未分组；不传表示不过滤 |
| days | ❌ | 仅检索最近 X 天（基于 `created_at`），不传表示不过滤 |

分层检索与保留规则：
- 设 `L` 为层数（`query` 中 `->` 分隔的段数，最大 3），`k=topK`
- 最终层（第 `L` 层）保留 `k` 条；第 `L-1` 层保留 `2*k` 条；第 `L-2` 层保留 `4*k` 条（逐层翻倍）
- 示例：`k=3` 且 `L=3` 时，第一层保留 12 条，第二层保留 6 条，最终层返回 3 条

响应（成功）：
```json
{
  "success": true,
  "data": {
    "results": [
      {
        "id": "uuid",
        "user_id": "uuid",
        "title": "春日复古穿搭",
        "content_type": "xiaohongshu",
        "content": "主要内容...",
        "author": "@可乐加冰",
        "tags": ["春季", "穿搭"],
        "score": 0.84
      }
    ]
  }
}
```

说明：
- 检索逻辑使用数据库向量索引 `knowledge_base_embedding_idx`，按余弦相似度排序。
- 仅返回 `embedding` 非空的帖子，按得分降序截取 `topK` 条。
- 若无满足阈值的结果，返回空数组。

