# ğŸ“‹ è‡ªå®šä¹‰å­—æ®µç®¡ç†

## ğŸ“– äº§å“æ¦‚è¿°

### åŠŸèƒ½æ¦‚è¿°
è‡ªå®šä¹‰å­—æ®µç®¡ç†ç³»ç»Ÿï¼Œæ”¯æŒä¸‰ç§ä¸šåŠ¡ç±»å‹ï¼ˆæ´å¯Ÿã€é’©å­ã€æƒ…ç»ªï¼‰çš„æ•°æ®åˆ›å»ºã€ç¼–è¾‘ã€åˆ é™¤å’ŒæŸ¥è¯¢ï¼ŒåŒ…å«åŠ¨æ€å­—æ®µç®¡ç†ã€æƒé™æ§åˆ¶ã€è½¯åˆ é™¤ç­‰åŠŸèƒ½ã€‚

---

## ğŸ¯ åŠŸèƒ½éœ€æ±‚

### 1. é¡µé¢å¸ƒå±€è®¾è®¡

#### 1.1 æ•´ä½“å¸ƒå±€
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    é¡¶éƒ¨å¯¼èˆªæ                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚              â”‚                                              â”‚
â”‚   å·¦ä¾§å¯¼èˆª   â”‚                ä¸»å†…å®¹åŒºåŸŸ                   â”‚
â”‚   (æ–‡ä»¶å¤¹)   â”‚                                              â”‚
â”‚              â”‚                                              â”‚
â”‚              â”‚                                              â”‚
â”‚              â”‚                                              â”‚
â”‚              â”‚                                              â”‚
â”‚              â”‚                                              â”‚
â”‚              â”‚                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 1.2 å·¦ä¾§å¯¼èˆªç»“æ„
```
ğŸ“ è‡ªå®šä¹‰æ•°æ®ç®¡ç†
  â”œâ”€â”€ ğŸ§  æ´å¯Ÿ (12)
  â”œâ”€â”€ ğŸª é’©å­ (8)
  â””â”€â”€ ğŸ’« æƒ…ç»ª (15)
```

- **å±•ç¤ºæ–¹å¼**: æ–‡ä»¶å¤¹å›¾æ ‡ + ç±»å‹åç§° + æ•°æ®æ¡æ•°
- **äº¤äº’æ•ˆæœ**: æ‚¬åœé«˜äº®ï¼Œé€‰ä¸­çŠ¶æ€æ˜æ˜¾æ ‡è¯†
- **é»˜è®¤çŠ¶æ€**: é€‰ä¸­"æ´å¯Ÿ"æ–‡ä»¶å¤¹

### 2. ä¸»å†…å®¹åŒºåŸŸåŠŸèƒ½

#### 2.1 é¡¶éƒ¨æ“ä½œæ 
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“‹ æ´å¯Ÿæ•°æ®ç®¡ç†                                    â• æ–°å»º  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ” [æœç´¢æ¡†]  ğŸ“… [æ—¶é—´ç­›é€‰]  ğŸ’° [é‡‘é¢ç­›é€‰]  ğŸ”„ åˆ·æ–°        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**åŠŸèƒ½è¯´æ˜**:
- **é¡µé¢æ ‡é¢˜**: åŠ¨æ€æ˜¾ç¤ºå½“å‰é€‰ä¸­çš„ç±»å‹
- **æ–°å»ºæŒ‰é’®**: ä¸»è¦æ“ä½œæŒ‰é’®ï¼Œé†’ç›®æ ·å¼
- **æœç´¢åŠŸèƒ½**: æ”¯æŒæ ‡é¢˜å’Œå†…å®¹æ¨¡ç³Šæœç´¢
- **ç­›é€‰åŠŸèƒ½**: æ—¶é—´èŒƒå›´ã€é‡‘é¢èŒƒå›´ç­›é€‰
- **åˆ·æ–°æŒ‰é’®**: æ‰‹åŠ¨åˆ·æ–°æ•°æ®

#### 2.2 æ•°æ®åˆ—è¡¨å±•ç¤º

**å¡ç‰‡å¼å¸ƒå±€**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“„ æ¢ç´¢Supabaseçš„å¼ºå¤§åŠŸèƒ½              ğŸ’° Â¥199.99  âš™ï¸ æ“ä½œ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ“ Supabaseæ˜¯ä¸€ä¸ªä¼˜ç§€çš„å¼€æºFirebaseæ›¿ä»£å“...             â”‚
â”‚  ğŸ‘¤ åˆ›å»ºè€…: å¼ ä¸‰  |  ğŸ“± APP: MARKETING_APP_01  |  ğŸ•’ 2025-09-09 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å­—æ®µæ˜¾ç¤ºä¼˜å…ˆçº§**:
1. **ä¸»è¦ä¿¡æ¯**: ä» extended_field ä¸­æå– title (æ ‡é¢˜ï¼Œå¿…å¡«)ã€é‡‘é¢ã€æ“ä½œæŒ‰é’®
2. **æ¬¡è¦ä¿¡æ¯**: ä» readme å­—æ®µè·å–æ­£æ–‡å†…å®¹ (æˆªå–å‰50å­—é¢„è§ˆ)
3. **å…ƒæ•°æ®**: created_user_id (åˆ›å»ºè€…)ã€app_codeã€created_atã€visibility/is_publicçŠ¶æ€
4. **æ‰©å±•ä¿¡æ¯**: extended_field ä¸­çš„å…¶ä»–è‡ªå®šä¹‰å­—æ®µ (å…¨éƒ¨ä¸ºtextç±»å‹)

**äº¤äº’åŠŸèƒ½**:
- **ç‚¹å‡»å¡ç‰‡**: è¿›å…¥è¯¦æƒ…é¡µ
- **æ‚¬åœæ•ˆæœ**: å¡ç‰‡è½»å¾®ä¸Šæµ® + é˜´å½±åŠ æ·±
- **æ“ä½œæŒ‰é’®**: ç¼–è¾‘ã€å¤åˆ¶ã€åˆ é™¤

#### 2.3 åˆ†é¡µç»„ä»¶
- **ä½ç½®**: åˆ—è¡¨åº•éƒ¨
- **æ ·å¼**: ä¸é¡¹ç›®æ•´ä½“é£æ ¼ä¸€è‡´
- **åŠŸèƒ½**: é¡µç åˆ‡æ¢ã€æ¯é¡µæ¡æ•°è®¾ç½®(10/20/50)

### 3. æ–°å»º/ç¼–è¾‘åŠŸèƒ½

#### 3.1 å¼¹çª—è®¾è®¡
- **ç±»å‹**: Modal å¼¹çª—
- **å°ºå¯¸**: ä¸­ç­‰å¤§å° (600px å®½åº¦)
- **æ ·å¼**: ç»ç’ƒå½¢æ€æ•ˆæœï¼Œä¸é¡¹ç›®é£æ ¼ä¸€è‡´

#### 3.2 è¡¨å•ç»“æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      æ–°å»ºæ´å¯Ÿæ•°æ®                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  åŸºç¡€ä¿¡æ¯                                                   â”‚
â”‚  â”œâ”€â”€ åº”ç”¨ä»£ç : [MARKETING_APP_01] (å¯é€‰æ‹©)                â”‚
â”‚  â”œâ”€â”€ é‡‘é¢: [Â¥   ] (æ”¯æŒå°æ•°ï¼Œè‡ªåŠ¨è½¬æ¢)                    â”‚
â”‚  â”œâ”€â”€ ğŸ“– è¯´æ˜æ–‡æ¡£ (å¿…å¡«)                                   â”‚
â”‚  â”‚   [å¤šè¡Œæ–‡æœ¬æ¡†]                                         â”‚
â”‚  â”œâ”€â”€ ğŸ’¡ ç¤ºä¾‹æ•°æ® (å¯é€‰)                                   â”‚
â”‚  â”‚   [æ–‡æœ¬æ¡†]                                             â”‚
â”‚  â””â”€â”€ âš™ï¸ æƒé™è®¾ç½®                                          â”‚
â”‚      â”œâ”€â”€ ğŸ‘ï¸ å¯è§æ€§: [å¼€å…³] (é»˜è®¤å¼€å¯)                   â”‚
â”‚      â””â”€â”€ ğŸŒ å…¬å¼€æ€§: [å¼€å…³] (é»˜è®¤å…³é—­)                   â”‚
â”‚                                                           â”‚
â”‚  æ‰©å±•å­—æ®µ                                                   â”‚
â”‚  â”œâ”€â”€ ğŸ“ æ ‡é¢˜ (å¿…å¡«)                                       â”‚
â”‚  â”‚   [è¾“å…¥æ¡†]                                             â”‚
â”‚  â”œâ”€â”€ ğŸ“„ æ­£æ–‡ (å¯é€‰ï¼Œå¯åˆ é™¤)                               â”‚
â”‚  â”‚   [æ–‡æœ¬åŸŸ] [ğŸ—‘ï¸åˆ é™¤]                                    â”‚
â”‚  â””â”€â”€ â• æ·»åŠ è‡ªå®šä¹‰å­—æ®µ (æ–‡æœ¬ç±»å‹)                          â”‚
â”‚                                                           â”‚
â”‚  [å–æ¶ˆ]                                    [ä¿å­˜] [ä¿å­˜å¹¶æ–°å»º] â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 3.3 æ‰©å±•å­—æ®µç®¡ç†

**é¢„è®¾å­—æ®µ**:
- **æ ‡é¢˜**: å¿…å¡«å­—æ®µï¼Œä¸å¯åˆ é™¤
- **æ­£æ–‡**: å¯é€‰å­—æ®µï¼Œå¯ä»¥åˆ é™¤

**è‡ªå®šä¹‰å­—æ®µç‰¹æ€§**:
- **å­—æ®µç±»å‹**: ç›®å‰ç»Ÿä¸€ä¸ºæ–‡æœ¬ç±»å‹ (åç»­å¯æ‰©å±•)
- **å­—æ®µåç§°**: ç”¨æˆ·è‡ªå®šä¹‰ (key å’Œ label)
- **å­—æ®µå€¼**: æ–‡æœ¬è¾“å…¥æ¡†
- **å¿…å¡«è®¾ç½®**: é»˜è®¤ä¸ºå¯é€‰

**å­—æ®µæ“ä½œ**:
- **æ·»åŠ å­—æ®µ**: ç‚¹å‡»"æ·»åŠ è‡ªå®šä¹‰å­—æ®µ"æŒ‰é’®
- **åˆ é™¤å­—æ®µ**: å­—æ®µå³ä¾§åˆ é™¤æŒ‰é’® (æ ‡é¢˜ä¸å¯åˆ é™¤)
- **æ’åºå­—æ®µ**: æ‹–æ‹½æ’åºåŠŸèƒ½ (v1.0æš‚ä¸å®ç°)
- **å­—æ®µéªŒè¯**: åŸºç¡€æ–‡æœ¬éªŒè¯

#### 3.4 è¡¨å•éªŒè¯è§„åˆ™

**å¿…å¡«å­—æ®µéªŒè¯**:
- åº”ç”¨ä»£ç : å¿…å¡«ï¼Œæ ¼å¼éªŒè¯
- è¯´æ˜æ–‡æ¡£ (readme): å¿…å¡«ï¼Œæœ€å°‘10å­—ç¬¦
- æ ‡é¢˜ (extended_field): å¿…å¡«ï¼Œæœ€å°‘2å­—ç¬¦

**å¯é€‰å­—æ®µéªŒè¯**:
- é‡‘é¢: éè´Ÿæ•°ï¼Œæœ€å¤š2ä½å°æ•°
- ç¤ºä¾‹æ•°æ®: æœ€å¤§500å­—ç¬¦
- æ­£æ–‡ (extended_field): å¯é€‰ï¼Œæœ€å¤§1000å­—ç¬¦
- è‡ªå®šä¹‰å­—æ®µ: æ–‡æœ¬éªŒè¯ï¼Œæœ€å¤§255å­—ç¬¦

**é«˜çº§éªŒè¯**:
- æ‰©å±•å­—æ®µåå”¯ä¸€æ€§æ£€æŸ¥ (keyä¸èƒ½é‡å¤)
- ç‰¹æ®Šå­—ç¬¦è¿‡æ»¤ (é˜²æ­¢XSS)
- æƒé™è®¾ç½®é€»è¾‘éªŒè¯

---

## ğŸ¨ ç”¨æˆ·ç•Œé¢è®¾è®¡

### è®¾è®¡è¦æ±‚
- **é£æ ¼ä¸€è‡´**: éµå¾ª Loomi-Lab ç°æœ‰è®¾è®¡ç³»ç»Ÿ
- **å›¾æ ‡æ ‡è¯†**: æ´å¯Ÿ(ğŸ§ )ã€é’©å­(ğŸª)ã€æƒ…ç»ª(ğŸ’«)  
- **å“åº”å¼**: é€‚é…æ¡Œé¢å’Œç§»åŠ¨ç«¯
- **äº¤äº’æµç•…**: å¡ç‰‡æ‚¬åœæ•ˆæœã€æŒ‰é’®åé¦ˆ

---

## ğŸ’¾ æ•°æ®åº“è®¾è®¡

### 1. æ•°æ®åº“è¡¨ç»“æ„

#### 1.1 book_user_custom_fields è¡¨å®šä¹‰

| å­—æ®µå | ç±»å‹ | è¯´æ˜ | çº¦æŸ |
|--------|------|------|------|
| id | UUID | è®°å½•çš„å”¯ä¸€ID | PRIMARY KEY, è‡ªåŠ¨ç”Ÿæˆ |
| user_id | UUID | æ•°æ®æ‰€å±çš„ç”¨æˆ·ID | NOT NULL, å¤–é”® |
| created_user_id | UUID | åˆ›å»ºè¿™æ¡è®°å½•çš„ç”¨æˆ·ID | NOT NULL, å¤–é”® |
| app_code | TEXT | æ‰€å±åº”ç”¨çš„ä»£ç ï¼Œå¦‚ 'MARKETING_APP_01' | NOT NULL |
| type | ENUM | ä¸šåŠ¡ç±»å‹ï¼š'æ´å¯Ÿ', 'é’©å­', 'æƒ…ç»ª' | NOT NULL |
| extended_field | JSONB | è‡ªå®šä¹‰å­—æ®µæ•°ç»„ | NOT NULL, é»˜è®¤ '[]' |
| amount | BIGINT | é‡‘é¢ï¼Œä»¥åˆ†ä¸ºå•ä½å­˜å‚¨ | NOT NULL, é»˜è®¤ 0 |
| post_ids | UUID[] | å…³è”çš„æ–‡ç« IDåˆ—è¡¨ | é»˜è®¤ '{}' |
| visibility | BOOLEAN | å¯è§æ€§ï¼Œtrue ä¸ºå¯è§ | NOT NULL, é»˜è®¤ true |
| is_public | BOOLEAN | æ˜¯å¦å…¬å¼€ï¼Œtrue ä¸ºå…¬å¼€ | NOT NULL, é»˜è®¤ false |
| example_data | TEXT | ç¤ºä¾‹æ•°æ®ï¼ˆå¯é€‰ï¼‰ | å¯ä¸ºç©º |
| readme | TEXT | è¯´æ˜æ–‡æ¡£ï¼ˆå¿…å¡«ï¼‰ | NOT NULL |
| is_deleted | BOOLEAN | è½¯åˆ é™¤æ ‡è®°ï¼Œtrue ä¸ºå·²åˆ é™¤ | NOT NULL, é»˜è®¤ false |
| created_at | TIMESTAMPTZ | åˆ›å»ºæ—¶é—´ | NOT NULL, é»˜è®¤ NOW() |
| updated_at | TIMESTAMPTZ | æœ€åæ›´æ–°æ—¶é—´ | NOT NULL, é»˜è®¤ NOW() |

#### 1.2 å­—æ®µè¯´æ˜
- **id**: ä½¿ç”¨UUIDä½œä¸ºä¸»é”®ï¼Œè‡ªåŠ¨ç”Ÿæˆ
- **user_id**: å…³è”ç”¨æˆ·è¡¨ï¼Œæ•°æ®æƒé™æ§åˆ¶åŸºç¡€
- **created_user_id**: è®°å½•åˆ›å»ºè€…ï¼Œç”¨äºæƒé™éªŒè¯
- **app_code**: åº”ç”¨æ ‡è¯†ï¼Œæ”¯æŒå¤šåº”ç”¨æ•°æ®éš”ç¦»
- **type**: ä¸šåŠ¡ç±»å‹æšä¸¾ï¼Œæ”¯æŒä¸‰ç§ç±»å‹
- **extended_field**: JSONBæ ¼å¼å­˜å‚¨è‡ªå®šä¹‰å­—æ®µï¼Œé»˜è®¤åŒ…å«title(å¿…å¡«)å’Œcontent(é€‰å¡«)
- **amount**: é‡‘é¢ä»¥åˆ†ä¸ºå•ä½å­˜å‚¨ï¼Œé¿å…æµ®ç‚¹ç²¾åº¦é—®é¢˜
- **post_ids**: å…³è”æ–‡ç« IDæ•°ç»„ï¼Œä¸ºåç»­åŠŸèƒ½é¢„ç•™
- **visibility**: å¯è§æ€§æ§åˆ¶ï¼Œfalseæ—¶å¯¹å…¶ä»–ç”¨æˆ·ä¸å¯è§
- **is_public**: å…¬å¼€æ€§æ§åˆ¶ï¼Œtrueæ—¶æ‰€æœ‰ç”¨æˆ·å¯æŸ¥çœ‹
- **example_data**: å¯é€‰çš„ç¤ºä¾‹æ•°æ®è¯´æ˜ï¼Œå¸®åŠ©ç”¨æˆ·ç†è§£
- **readme**: å¿…å¡«çš„è¯´æ˜æ–‡æ¡£ï¼Œæ˜¾ç¤ºä¸ºæ­£æ–‡å†…å®¹
- **is_deleted**: è½¯åˆ é™¤æ ‡è®°ï¼Œæ”¯æŒæ•°æ®æ¢å¤

#### 1.3 ç°æœ‰æ•°æ®åº“è¡¨è¯´æ˜

> **ğŸ“ æ³¨æ„**: `book_user_custom_fields` è¡¨å·²åœ¨æ•°æ®åº“ä¸­å­˜åœ¨ï¼Œæ— éœ€åˆ›å»ºã€‚

**è¡¨ç»“æ„éªŒè¯SQL** (å¯ç”¨äºç¡®è®¤è¡¨ç»“æ„):
```sql
-- æŸ¥çœ‹è¡¨ç»“æ„
\d book_user_custom_fields;

-- æŸ¥çœ‹è¡¨ç´¢å¼•
SELECT indexname, indexdef 
FROM pg_indexes 
WHERE tablename = 'book_user_custom_fields';

-- æŸ¥çœ‹è¡¨çº¦æŸ
SELECT conname, contype, consrc 
FROM pg_constraint 
WHERE conrelid = 'book_user_custom_fields'::regclass;
```

**æ¨èçš„é¢å¤–ç´¢å¼•** (å¦‚æœå°šæœªåˆ›å»º):
```sql
-- å¦‚æœè¿™äº›ç´¢å¼•ä¸å­˜åœ¨ï¼Œå¯ä»¥æ·»åŠ ä»¥æå‡æŸ¥è¯¢æ€§èƒ½
CREATE INDEX IF NOT EXISTS idx_custom_fields_user_type 
    ON book_user_custom_fields (user_id, type, is_deleted);
CREATE INDEX IF NOT EXISTS idx_custom_fields_app_code 
    ON book_user_custom_fields (app_code, is_deleted);
CREATE INDEX IF NOT EXISTS idx_custom_fields_created_at 
    ON book_user_custom_fields (created_at DESC);
CREATE INDEX IF NOT EXISTS idx_custom_fields_visibility 
    ON book_user_custom_fields (visibility, is_public, is_deleted);

-- JSONBå­—æ®µç´¢å¼• (æ ¹æ®æŸ¥è¯¢éœ€æ±‚å¯é€‰æ·»åŠ )
CREATE INDEX IF NOT EXISTS idx_custom_fields_extended_title 
    ON book_user_custom_fields USING GIN ((extended_field -> 'title'));
```

#### 1.4 è½¯åˆ é™¤ç­–ç•¥
- **åˆ é™¤æ“ä½œ**: åªè®¾ç½® `is_deleted = true`ï¼Œä¸ç‰©ç†åˆ é™¤æ•°æ®
- **æŸ¥è¯¢ç­–ç•¥**: æ‰€æœ‰æŸ¥è¯¢éƒ½è¦æ·»åŠ  `WHERE is_deleted = false` æ¡ä»¶
- **æ¢å¤æœºåˆ¶**: ç®¡ç†å‘˜å¯ä»¥å°† `is_deleted` è®¾ä¸º `false` æ¥æ¢å¤æ•°æ®
- **æ¸…ç†ç­–ç•¥**: å®šæœŸæ¸…ç†è¶…è¿‡90å¤©çš„è½¯åˆ é™¤æ•°æ®ï¼ˆå¯é€‰ï¼‰

### 2. æ•°æ®æ¨¡å‹

#### 2.1 å‰ç«¯æ•°æ®ç»“æ„
```typescript
interface CustomFieldRecord {
  id: string
  userId: string
  createdUserId: string
  appCode: string
  type: 'æ´å¯Ÿ' | 'é’©å­' | 'æƒ…ç»ª'
  extendedField: CustomField[]
  amount: number // å‰ç«¯æ˜¾ç¤ºçš„å®é™…é‡‘é¢ (å…ƒ)
  postIds: string[]
  visibility: boolean
  isPublic: boolean
  exampleData?: string
  readme: string
  isDeleted: boolean
  createdAt: string
  updatedAt: string
}

interface CustomField {
  key: string
  label: string
  value: string // ç›®å‰ç»Ÿä¸€ä¸ºå­—ç¬¦ä¸²ç±»å‹
  type?: 'text' // ç›®å‰åªæ”¯æŒæ–‡æœ¬ç±»å‹
  required?: boolean
}
```

#### 2.2 è¡¨å•æ•°æ®ç»“æ„
```typescript
interface CustomFieldForm {
  appCode: string
  amount: number
  readme: string
  exampleData?: string
  visibility: boolean
  isPublic: boolean
  extendedField: CustomField[]
}

interface CustomFieldInput {
  key: string
  label: string
  value: string
  removable: boolean // æ˜¯å¦å¯åˆ é™¤ (æ ‡é¢˜ä¸å¯åˆ é™¤)
}
```

### 2. æ•°æ®éªŒè¯

#### 2.1 å‰ç«¯éªŒè¯
- **å®æ—¶éªŒè¯**: ç”¨æˆ·è¾“å…¥æ—¶å³æ—¶åé¦ˆ
- **æäº¤éªŒè¯**: è¡¨å•æäº¤å‰å®Œæ•´æ£€æŸ¥
- **æ ¼å¼éªŒè¯**: ç‰¹æ®Šå­—æ®µæ ¼å¼è¦æ±‚

#### 2.2 åç«¯éªŒè¯
- **æ•°æ®ç±»å‹éªŒè¯**: ä¸¥æ ¼çš„ç±»å‹æ£€æŸ¥
- **ä¸šåŠ¡è§„åˆ™éªŒè¯**: è‡ªå®šä¹‰ä¸šåŠ¡é€»è¾‘
- **å®‰å…¨éªŒè¯**: SQLæ³¨å…¥ã€XSSé˜²æŠ¤

### 3. é‡‘é¢å¤„ç†é€»è¾‘

#### 3.1 å‰ç«¯å¤„ç†
```
ç”¨æˆ·è¾“å…¥: 199.99 (å…ƒ)
â†“ 
æ˜¾ç¤º: Â¥199.99
â†“
æäº¤å‰å¤„ç†: 199.99 * 100 = 19999 (åˆ†)
```

#### 3.2 åç«¯å¤„ç†  
```
æ¥æ”¶: 19999 (åˆ†)
â†“
å­˜å‚¨: amount = 19999
â†“
è¿”å›: amount / 100 = 199.99 (å…ƒ)
```

---

## ğŸ”Œ API è®¾è®¡

### 1. API è·¯ç”±è§„åˆ’

#### 1.1 RESTful API è®¾è®¡
```
GET    /api/custom-fields                    # è·å–åˆ—è¡¨ (è‡ªåŠ¨è¿‡æ»¤ is_deleted=false)
POST   /api/custom-fields                    # åˆ›å»ºè®°å½•  
GET    /api/custom-fields/[id]              # è·å–è¯¦æƒ… (éªŒè¯ is_deleted=false)
PUT    /api/custom-fields/[id]              # æ›´æ–°è®°å½• (éªŒè¯ is_deleted=false)
DELETE /api/custom-fields/[id]              # è½¯åˆ é™¤è®°å½• (è®¾ç½® is_deleted=true)
GET    /api/custom-fields/stats             # è·å–ç»Ÿè®¡ (åªç»Ÿè®¡æœªåˆ é™¤æ•°æ®)
```

#### 1.2 æŸ¥è¯¢è¿‡æ»¤è§„åˆ™
**æ‰€æœ‰æŸ¥è¯¢æ“ä½œéƒ½å¿…é¡»åŒ…å«è½¯åˆ é™¤è¿‡æ»¤æ¡ä»¶**:
```sql
WHERE is_deleted = false
```

**ç¤ºä¾‹SQLæŸ¥è¯¢**:
```sql
-- è·å–åˆ—è¡¨
SELECT * FROM book_user_custom_fields 
WHERE user_id = $1 AND type = $2 AND is_deleted = false
ORDER BY created_at DESC;

-- è·å–è¯¦æƒ…  
SELECT * FROM book_user_custom_fields 
WHERE id = $1 AND is_deleted = false;

-- è½¯åˆ é™¤
UPDATE book_user_custom_fields 
SET is_deleted = true, updated_at = NOW() 
WHERE id = $1 AND is_deleted = false;
```

#### 1.3 æŸ¥è¯¢å‚æ•°è®¾è®¡
```typescript
interface ListQueryParams {
  type?: 'æ´å¯Ÿ' | 'é’©å­' | 'æƒ…ç»ª'
  page?: number
  limit?: number
  search?: string // æœç´¢titleå’Œreadmeå­—æ®µ
  appCode?: string
  amountMin?: number
  amountMax?: number
  dateFrom?: string
  dateTo?: string
  visibility?: boolean
  isPublic?: boolean
  sortBy?: string
  sortOrder?: 'asc' | 'desc'
}
```

### 2. API è¯·æ±‚/å“åº”æ ¼å¼

#### 2.1 è·å–åˆ—è¡¨ API
**è¯·æ±‚**:
```
GET /api/custom-fields?type=æ´å¯Ÿ&page=1&limit=10&search=Supabase
```

**å“åº”**:
```json
{
  "success": true,
  "data": {
    "records": [...],
    "pagination": {
      "page": 1,
      "limit": 10,
      "total": 25,
      "totalPages": 3
    },
    "stats": {
      "totalAmount": 1999900,
      "avgAmount": 79996
    }
  }
}
```

#### 2.2 åˆ›å»ºè®°å½• API
**è¯·æ±‚**:
```json
{
  "appCode": "MARKETING_APP_01",
  "type": "æ´å¯Ÿ",
  "amount": 19999,
  "readme": "è¿™æ˜¯ä¸€ä¸ªå¿…å¡«çš„è¯´æ˜æ–‡æ¡£ï¼Œç”¨äºè§£é‡Šæ­¤é¡¹æ•°æ®ã€‚",
  "exampleData": "è¿™æ˜¯ä¸€ä¸ªå¯é€‰çš„ç¤ºä¾‹æ•°æ®è¯´æ˜ã€‚",
  "visibility": true,
  "isPublic": false,
  "extendedField": [
    {
      "key": "title",
      "label": "æ ‡é¢˜", 
      "value": "æ¢ç´¢Supabaseçš„å¼ºå¤§åŠŸèƒ½"
    },
    {
      "key": "content",
      "label": "æ­£æ–‡",
      "value": "è¯¦ç»†çš„å†…å®¹æè¿°..."
    }
  ]
}
```

**å“åº”**:
```json
{
  "success": true,
  "data": {
    "id": "a1b2c3d4-e5f6-g7h8-i9j0-k1l2m3n4o5p6",
    "message": "åˆ›å»ºæˆåŠŸ"
  }
}
```

### 3. é”™è¯¯å¤„ç†

#### 3.1 é”™è¯¯å“åº”æ ¼å¼
```json
{
  "success": false,
  "error": "å‚æ•°éªŒè¯å¤±è´¥",
  "details": {
    "field": "amount",
    "message": "é‡‘é¢ä¸èƒ½ä¸ºè´Ÿæ•°"
  },
  "code": "VALIDATION_ERROR"
}
```

#### 3.2 é”™è¯¯ä»£ç å®šä¹‰
- `VALIDATION_ERROR`: å‚æ•°éªŒè¯å¤±è´¥
- `NOT_FOUND`: è®°å½•ä¸å­˜åœ¨
- `DUPLICATE_FIELD`: å­—æ®µé‡å¤
- `PERMISSION_DENIED`: æƒé™ä¸è¶³
- `SERVER_ERROR`: æœåŠ¡å™¨å†…éƒ¨é”™è¯¯

---

## ğŸ“± åŠŸèƒ½äº¤äº’æµç¨‹

### 1. æŸ¥çœ‹æ•°æ®æµç¨‹
```
ç”¨æˆ·è¿›å…¥é¡µé¢ 
â†’ é»˜è®¤é€‰ä¸­"æ´å¯Ÿ"æ–‡ä»¶å¤¹
â†’ åŠ è½½æ´å¯Ÿç±»å‹æ•°æ®åˆ—è¡¨
â†’ æ˜¾ç¤ºåˆ†é¡µå’Œç»Ÿè®¡ä¿¡æ¯
â†’ ç”¨æˆ·å¯åˆ‡æ¢å…¶ä»–æ–‡ä»¶å¤¹
â†’ åŠ¨æ€åŠ è½½å¯¹åº”ç±»å‹æ•°æ®
```

### 2. åˆ›å»ºæ•°æ®æµç¨‹
```
ç‚¹å‡»"æ–°å»º"æŒ‰é’®
â†’ å¼¹å‡ºåˆ›å»ºè¡¨å•Modal
â†’ è‡ªåŠ¨è®¾ç½®å½“å‰é€‰ä¸­çš„ç±»å‹
â†’ ç”¨æˆ·å¡«å†™åŸºç¡€ä¿¡æ¯å’Œè‡ªå®šä¹‰å­—æ®µ
â†’ å®æ—¶è¡¨å•éªŒè¯
â†’ æäº¤æ•°æ® 
â†’ åç«¯éªŒè¯å’Œä¿å­˜
â†’ è¿”å›ç»“æœ
â†’ æ›´æ–°åˆ—è¡¨æ•°æ®
â†’ å…³é—­Modal
```

### 3. ç¼–è¾‘æ•°æ®æµç¨‹
```
ç‚¹å‡»è®°å½•å¡ç‰‡æˆ–ç¼–è¾‘æŒ‰é’®
â†’ è·å–è®°å½•è¯¦æƒ…æ•°æ®
â†’ å¼¹å‡ºç¼–è¾‘è¡¨å•Modal
â†’ é¢„å¡«å……ç°æœ‰æ•°æ®
â†’ ç”¨æˆ·ä¿®æ”¹å­—æ®µå€¼
â†’ å®æ—¶éªŒè¯å˜æ›´
â†’ æäº¤æ›´æ–°
â†’ åç«¯éªŒè¯å’Œä¿å­˜
â†’ è¿”å›æ›´æ–°ç»“æœ
â†’ åˆ·æ–°åˆ—è¡¨æ•°æ®
```

### 4. è½¯åˆ é™¤æ•°æ®æµç¨‹
```
ç‚¹å‡»åˆ é™¤æŒ‰é’®
â†’ æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡† ("æ­¤æ“ä½œå°†æ ‡è®°æ•°æ®ä¸ºå·²åˆ é™¤")
â†’ ç”¨æˆ·ç¡®è®¤åˆ é™¤
â†’ å‘é€è½¯åˆ é™¤è¯·æ±‚ (PATCH /api/custom-fields/[id])
â†’ åç«¯æ‰§è¡Œ: UPDATE ... SET is_deleted = true, updated_at = NOW()
â†’ è¿”å›åˆ é™¤ç»“æœ
â†’ å‰ç«¯ä»åˆ—è¡¨ä¸­ç§»é™¤è¯¥è®°å½• (è§†è§‰ä¸Šåˆ é™¤)
â†’ æ•°æ®åº“ä¸­ä¿ç•™è®°å½•ä½†æ ‡è®°ä¸ºå·²åˆ é™¤
```

**åˆ é™¤ç¡®è®¤å¯¹è¯æ¡†å†…å®¹**:
```
âš ï¸ ç¡®è®¤åˆ é™¤æ•°æ®
æ­¤æ“ä½œå°†æ ‡è®°æ•°æ®ä¸ºå·²åˆ é™¤çŠ¶æ€ï¼Œç®¡ç†å‘˜å¯ä»¥æ¢å¤ã€‚
æ•°æ®æ ‡é¢˜: "æ¢ç´¢Supabaseçš„å¼ºå¤§åŠŸèƒ½"
åˆ›å»ºæ—¶é—´: 2025-09-09

[å–æ¶ˆ] [ç¡®è®¤åˆ é™¤]
```

---

## ğŸ” æƒé™æ§åˆ¶

### 1. é¡µé¢è®¿é—®æƒé™
- **admin**: å®Œæ•´çš„å¢åˆ æŸ¥æ”¹æƒé™
- **operator**: æŸ¥çœ‹å’Œç¼–è¾‘æƒé™ï¼Œä¸èƒ½åˆ é™¤
- **viewer**: ä»…æŸ¥çœ‹æƒé™

### 2. æ•°æ®æƒé™æ§åˆ¶
- **æ•°æ®éš”ç¦»**: åŸºäº visibility å’Œ is_public å­—æ®µæ§åˆ¶è®¿é—®æƒé™
- **åˆ›å»ºæƒé™**: è®°å½•åˆ›å»ºè€…ä¿¡æ¯ (created_user_id)
- **æ“ä½œæƒé™**: åªæœ‰åˆ›å»ºè€…å’Œç®¡ç†å‘˜å¯ä»¥ä¿®æ”¹/åˆ é™¤

### 3. å¯è§æ€§æƒé™è§„åˆ™
- **visibility = false**: ä»…åˆ›å»ºè€…å’Œç®¡ç†å‘˜å¯æŸ¥çœ‹
- **visibility = true, is_public = false**: åŒåº”ç”¨ç”¨æˆ·å¯æŸ¥çœ‹
- **visibility = true, is_public = true**: æ‰€æœ‰ç”¨æˆ·å¯æŸ¥çœ‹
- **æ•°æ®æŸ¥è¯¢**: è‡ªåŠ¨æ ¹æ®ç”¨æˆ·æƒé™è¿‡æ»¤æ•°æ®

### 4. å­—æ®µæƒé™
- **æ•æ„Ÿå­—æ®µ**: é‡‘é¢å­—æ®µéœ€è¦ç‰¹æ®Šæƒé™æŸ¥çœ‹
- **ç³»ç»Ÿå­—æ®µ**: idã€åˆ›å»ºæ—¶é—´ç­‰ç³»ç»Ÿå­—æ®µä¸å¯ç¼–è¾‘
- **æ‰©å±•å­—æ®µ**: æ ‡é¢˜å­—æ®µä¸å¯åˆ é™¤ï¼Œå…¶ä»–å­—æ®µå¯è‡ªç”±ç®¡ç†

---

## ğŸ§ª æ ¸å¿ƒæµ‹è¯•è¦ç‚¹

### å¿…æµ‹åŠŸèƒ½
- **CRUDæ“ä½œ**: å¢åˆ æŸ¥æ”¹åŠŸèƒ½å®Œæ•´æ€§
- **è½¯åˆ é™¤**: is_deletedå­—æ®µæ­£ç¡®å¤„ç†
- **æƒé™æ§åˆ¶**: visibility/is_publicæƒé™éªŒè¯
- **å­—æ®µéªŒè¯**: å¿…å¡«å­—æ®µå’Œæ ¼å¼éªŒè¯
- **æœç´¢ç­›é€‰**: å¤šç»´åº¦æ•°æ®ç­›é€‰
- **åˆ†é¡µ**: å¤§æ•°æ®é‡åˆ†é¡µåŠ è½½

### æ€§èƒ½è¦æ±‚
- æ•°æ®åŠ è½½å“åº”æ—¶é—´ < 500ms
- è¡¨å•æäº¤å“åº”æ—¶é—´ < 1s
- æ”¯æŒ1000+è®°å½•æµç•…æ“ä½œ

---


## ğŸ“ æŠ€æœ¯å®ç°è¦ç‚¹

### 1. å‰ç«¯å…³é”®æŠ€æœ¯
- **åŠ¨æ€è¡¨å•**: React Hook Form + è‡ªå®šä¹‰å­—æ®µæ¸²æŸ“
- **çŠ¶æ€ç®¡ç†**: Zustand ç®¡ç†é¡µé¢çŠ¶æ€
- **æ•°æ®è·å–**: React Query å¤„ç†APIè¯·æ±‚
- **è¡¨å•éªŒè¯**: Yup schema éªŒè¯
- **UIç»„ä»¶**: Chakra UI + è‡ªå®šä¹‰ç»„ä»¶

### 2. åç«¯å…³é”®æŠ€æœ¯

#### 2.1 SupabaseæŸ¥è¯¢æ¶æ„
å‚è€ƒé¡¹ç›®ç°æœ‰çš„ç”¨æˆ·ç®¡ç†å®ç°æ¨¡å¼ï¼Œé‡‡ç”¨**åŒå®¢æˆ·ç«¯æ¶æ„**ï¼š

```typescript
// å®¢æˆ·ç«¯å®ä¾‹ (æƒé™å—é™)
export const supabase = createClient(supabaseUrl, supabaseAnonKey)

// æœåŠ¡ç«¯å®ä¾‹ (å®Œæ•´æƒé™)
export const supabaseServiceRole = createClient(supabaseUrl, supabaseServiceRoleKey, {
  auth: {
    autoRefreshToken: false,
    persistSession: false
  }
})
```

#### 2.2 è‡ªå®šä¹‰å­—æ®µå­˜å‚¨æœåŠ¡å®ç°

```typescript
export class CustomFieldStorage {
  constructor(private supabase: SupabaseClient) {}

  /**
   * è·å–è‡ªå®šä¹‰å­—æ®µåˆ—è¡¨ï¼ˆåˆ†é¡µ+ç­›é€‰ï¼‰
   */
  async getCustomFields(options: {
    page?: number
    limit?: number
    search?: string
    type?: string
    appCode?: string
    userId?: string
    visibility?: boolean
    isPublic?: boolean
  } = {}) {
    try {
      const { 
        page = 1, 
        limit = 10, 
        search = '', 
        type = 'all', 
        appCode,
        userId,
        visibility,
        isPublic 
      } = options
      const offset = (page - 1) * limit

      // æ„å»ºåŸºç¡€æŸ¥è¯¢
      let query = this.supabase
        .from('book_user_custom_fields')
        .select('*')
        .eq('is_deleted', false) // è½¯åˆ é™¤è¿‡æ»¤

      // ç”¨æˆ·æƒé™è¿‡æ»¤
      if (userId) {
        query = query.eq('user_id', userId)
      }

      // ç±»å‹ç­›é€‰
      if (type !== 'all') {
        query = query.eq('type', type)
      }

      // åº”ç”¨ä»£ç ç­›é€‰
      if (appCode) {
        query = query.eq('app_code', appCode)
      }

      // å¯è§æ€§ç­›é€‰
      if (visibility !== undefined) {
        query = query.eq('visibility', visibility)
      }

      // å…¬å¼€æ€§ç­›é€‰
      if (isPublic !== undefined) {
        query = query.eq('is_public', isPublic)
      }

      // æœç´¢åŠŸèƒ½ (æœç´¢æ ‡é¢˜å’Œreadmeå­—æ®µ)
      if (search && search.trim() !== '') {
        query = query.or(
          `readme.ilike.%${search}%,` +
          `extended_field->title->>value.ilike.%${search}%`
        )
      }

      // åˆ†é¡µå’Œæ’åº
      const { data, error, count } = await query
        .order('created_at', { ascending: false })
        .range(offset, offset + limit - 1)

      if (error) throw error

      // è·å–æ€»æ•°
      const totalCount = count || 0
      const totalPages = Math.ceil(totalCount / limit)

      return {
        records: data || [],
        total: totalCount,
        page,
        limit,
        totalPages
      }
    } catch (error) {
      console.error('è·å–è‡ªå®šä¹‰å­—æ®µåˆ—è¡¨å¤±è´¥:', error)
      return {
        records: [],
        total: 0,
        page: options.page || 1,
        limit: options.limit || 10,
        totalPages: 0
      }
    }
  }

  /**
   * æ ¹æ®IDè·å–å•æ¡è®°å½•
   */
  async getCustomFieldById(id: string, userId?: string) {
    try {
      let query = this.supabase
        .from('book_user_custom_fields')
        .select('*')
        .eq('id', id)
        .eq('is_deleted', false)

      // æƒé™æ§åˆ¶: åªèƒ½æŸ¥çœ‹è‡ªå·±çš„æˆ–å…¬å¼€çš„æ•°æ®
      if (userId) {
        query = query.or(
          `user_id.eq.${userId},` +
          `and(visibility.eq.true,is_public.eq.true)`
        )
      }

      const { data, error } = await query.single()

      if (error) throw error
      return data
    } catch (error) {
      console.error('è·å–è‡ªå®šä¹‰å­—æ®µè¯¦æƒ…å¤±è´¥:', error)
      return null
    }
  }

  /**
   * åˆ›å»ºè‡ªå®šä¹‰å­—æ®µè®°å½•
   */
  async createCustomField(record: {
    userId: string
    createdUserId: string
    appCode: string
    type: string
    extendedField: any[]
    amount: number
    readme: string
    exampleData?: string
    visibility: boolean
    isPublic: boolean
  }) {
    try {
      const { data, error } = await this.supabase
        .from('book_user_custom_fields')
        .insert({
          user_id: record.userId,
          created_user_id: record.createdUserId,
          app_code: record.appCode,
          type: record.type,
          extended_field: record.extendedField,
          amount: record.amount, // å‰ç«¯å·²è½¬æ¢ä¸ºåˆ†
          readme: record.readme,
          example_data: record.exampleData,
          visibility: record.visibility,
          is_public: record.isPublic,
          post_ids: [], // é»˜è®¤ç©ºæ•°ç»„
          is_deleted: false
        })
        .select()
        .single()

      if (error) throw error
      return data
    } catch (error) {
      console.error('åˆ›å»ºè‡ªå®šä¹‰å­—æ®µå¤±è´¥:', error)
      throw error
    }
  }

  /**
   * æ›´æ–°è‡ªå®šä¹‰å­—æ®µè®°å½•
   */
  async updateCustomField(
    id: string, 
    userId: string, 
    updates: Partial<{
      appCode: string
      extendedField: any[]
      amount: number
      readme: string
      exampleData: string
      visibility: boolean
      isPublic: boolean
    }>
  ) {
    try {
      const { data, error } = await this.supabase
        .from('book_user_custom_fields')
        .update({
          app_code: updates.appCode,
          extended_field: updates.extendedField,
          amount: updates.amount,
          readme: updates.readme,
          example_data: updates.exampleData,
          visibility: updates.visibility,
          is_public: updates.isPublic,
          updated_at: new Date().toISOString()
        })
        .eq('id', id)
        .eq('user_id', userId) // æƒé™æ§åˆ¶: åªèƒ½æ›´æ–°è‡ªå·±çš„æ•°æ®
        .eq('is_deleted', false)
        .select()
        .single()

      if (error) throw error
      return data
    } catch (error) {
      console.error('æ›´æ–°è‡ªå®šä¹‰å­—æ®µå¤±è´¥:', error)
      throw error
    }
  }

  /**
   * è½¯åˆ é™¤è‡ªå®šä¹‰å­—æ®µè®°å½•
   */
  async deleteCustomField(id: string, userId: string) {
    try {
      const { data, error } = await this.supabase
        .from('book_user_custom_fields')
        .update({
          is_deleted: true,
          updated_at: new Date().toISOString()
        })
        .eq('id', id)
        .eq('user_id', userId) // æƒé™æ§åˆ¶: åªèƒ½åˆ é™¤è‡ªå·±çš„æ•°æ®
        .eq('is_deleted', false)
        .select()
        .single()

      if (error) throw error
      return data
    } catch (error) {
      console.error('åˆ é™¤è‡ªå®šä¹‰å­—æ®µå¤±è´¥:', error)
      throw error
    }
  }

  /**
   * è·å–ç»Ÿè®¡ä¿¡æ¯
   */
  async getStats(userId?: string) {
    try {
      const baseQuery = this.supabase
        .from('book_user_custom_fields')
        .select('type', { count: 'exact' })
        .eq('is_deleted', false)

      // ç”¨æˆ·æƒé™è¿‡æ»¤
      if (userId) {
        baseQuery.eq('user_id', userId)
      }

      // åˆ†åˆ«ç»Ÿè®¡ä¸‰ç§ç±»å‹
      const [insightCount, hookCount, emotionCount] = await Promise.all([
        baseQuery.eq('type', 'æ´å¯Ÿ'),
        baseQuery.eq('type', 'é’©å­'),
        baseQuery.eq('type', 'æƒ…ç»ª')
      ])

      return {
        æ´å¯Ÿ: insightCount.count || 0,
        é’©å­: hookCount.count || 0,
        æƒ…ç»ª: emotionCount.count || 0,
        æ€»è®¡: (insightCount.count || 0) + (hookCount.count || 0) + (emotionCount.count || 0)
      }
    } catch (error) {
      console.error('è·å–ç»Ÿè®¡ä¿¡æ¯å¤±è´¥:', error)
      return {
        æ´å¯Ÿ: 0,
        é’©å­: 0,
        æƒ…ç»ª: 0,
        æ€»è®¡: 0
      }
    }
  }
}

// åˆ›å»ºå…¨å±€å®ä¾‹
export const customFieldStorage = new CustomFieldStorage(supabaseServiceRole)
```

#### 2.3 æŸ¥è¯¢ä¼˜åŒ–è¦ç‚¹
- **ç´¢å¼•åˆ©ç”¨**: åˆ©ç”¨å¤åˆç´¢å¼• `(user_id, type, is_deleted)` æå‡æŸ¥è¯¢æ€§èƒ½
- **JSONBæœç´¢**: ä½¿ç”¨ GIN ç´¢å¼•æ”¯æŒ extended_field å­—æ®µçš„é«˜æ•ˆæŸ¥è¯¢
- **è½¯åˆ é™¤è¿‡æ»¤**: æ‰€æœ‰æŸ¥è¯¢éƒ½åŒ…å« `is_deleted = false` æ¡ä»¶
- **æƒé™è¿‡æ»¤**: åœ¨SQLå±‚é¢å®ç°æ•°æ®è®¿é—®æ§åˆ¶
- **åˆ†é¡µä¼˜åŒ–**: ä½¿ç”¨ `range()` æ–¹æ³•å®ç°é«˜æ•ˆåˆ†é¡µ

#### 2.4 é”™è¯¯å¤„ç†æ¨¡å¼
- **ç»Ÿä¸€å¼‚å¸¸æ•è·**: try-catch åŒ…è£…æ‰€æœ‰æ•°æ®åº“æ“ä½œ
- **è¯¦ç»†é”™è¯¯æ—¥å¿—**: console.error è®°å½•å…·ä½“é”™è¯¯ä¿¡æ¯
- **ä¼˜é›…é™çº§**: æŸ¥è¯¢å¤±è´¥æ—¶è¿”å›é»˜è®¤ç©ºæ•°æ®ç»“æ„
- **é”™è¯¯å“åº”æ ¼å¼**: æ ‡å‡†åŒ–çš„APIé”™è¯¯å“åº”

#### 2.5 æ•°æ®éªŒè¯
- **æœåŠ¡ç«¯éªŒè¯**: åœ¨æ•°æ®åº“å±‚é¢è¿›è¡Œç±»å‹å’Œçº¦æŸéªŒè¯
- **ä¸šåŠ¡è§„åˆ™éªŒè¯**: è‡ªå®šä¹‰éªŒè¯é€»è¾‘ (é‡‘é¢èŒƒå›´ã€å­—æ®µå”¯ä¸€æ€§ç­‰)
- **æƒé™éªŒè¯**: JWT token è§£æ + ç”¨æˆ·è§’è‰²æ£€æŸ¥
- **è¾“å…¥è¿‡æ»¤**: é˜²æ­¢ SQL æ³¨å…¥å’Œ XSS æ”»å‡»

### 3. æ•°æ®åº“è®¾è®¡è¦ç‚¹
- **JSONBå­—æ®µ**: extended_field ä½¿ç”¨JSONBå­˜å‚¨
- **ç´¢å¼•ä¼˜åŒ–**: ä¸ºå¸¸ç”¨æŸ¥è¯¢å­—æ®µåˆ›å»ºç´¢å¼•
- **è½¯åˆ é™¤**: is_deleted å­—æ®µå®ç°è½¯åˆ é™¤
- **å®¡è®¡ä¿¡æ¯**: created_at/updated_at è‡ªåŠ¨ç»´æŠ¤

