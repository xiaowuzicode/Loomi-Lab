# 用户消息查询功能说明

## 功能概述

用户消息查询功能已成功添加到Loomi-Lab管理平台中，位于左侧导航栏的"用户消息查询"菜单项。此功能允许管理员根据时间、用户ID、会话ID等条件查询用户的项目和消息记录。

## 主要特性

### 1. 多维度查询条件
- **时间范围查询**：支持按开始日期和结束日期筛选
- **用户ID查询**：查询特定用户的所有项目
- **会话ID查询**：查询特定项目（会话ID就是项目ID）
- **组合查询**：支持多个条件组合使用

### 2. 完整的数据展示
- 项目基本信息（标题、用户ID、会话ID、时间）
- 用户背景信息(user_background)
- 配置信息(config)
- 相关聊天消息记录

### 3. 便捷的操作功能
- **查看详情**：点击操作列的眼睛图标查看完整信息
- **Excel导出**：一键导出查询结果为CSV格式
- **数据刷新**：实时刷新查询结果
- **表单清空**：快速重置查询条件

## 使用方法

### 基本查询流程
1. 在左侧导航栏点击"💬 用户消息查询"
2. 在查询条件区域设置筛选条件：
   - 选择时间范围（可选）
   - 输入用户ID（可选）
   - 输入会话ID/project_id（可选）
3. 点击"查询"按钮执行搜索
4. 在结果表格中查看数据
5. 点击操作列的"👁️"图标查看详细信息

### 查询场景示例

#### 场景1：查询所有项目
- 不设置任何条件，直接点击查询
- 系统将返回最近5000条项目记录

#### 场景2：查询特定用户
- 在"用户ID"框中输入：`7f1dc54b-3a0c-4b70-96ce-a6ecea4924f8`
- 点击查询获取该用户的所有项目

#### 场景3：查询特定项目（会话）
- 在"会话ID"框中输入项目ID：`469efd43-f8e5-4a6e-96e8-541c634f3a31`
- 系统将返回该项目的信息和相关聊天消息

#### 场景4：时间范围查询
- 设置开始日期：`2024-01-01`
- 设置结束日期：`2024-12-31`
- 查询指定时间范围内的所有项目

#### 场景5：组合查询
- 同时设置用户ID和时间范围
- 查询特定用户在指定时间内的项目

## 数据导出

### CSV导出格式
导出的CSV文件包含以下列：
- 项目ID
- 标题
- 用户ID
- 会话ID
- 创建时间
- 更新时间
- 用户背景（JSON格式）
- 配置信息（JSON格式）
- 聊天消息数量

### 导出步骤
1. 执行查询获取结果
2. 点击右上角的Excel图标
3. 系统自动生成并下载CSV文件
4. 文件名格式：`用户消息查询结果_YYYY-MM-DD.csv`

## 技术实现

### 数据库函数
系统使用以下lab_前缀的数据库函数：
- `lab_query_user_projects()` - 查询用户的所有项目
- `lab_query_user_conversation()` - 查询用户的特定会话（通过conversation_id字段）
- `lab_query_project_by_id()` - 通过项目ID查询项目（会话ID就是项目ID）
- `lab_query_user_project_by_id()` - 查询特定用户的特定项目
- `lab_query_projects_by_date()` - 按时间范围查询所有项目
- `lab_get_all_project_titles()` - 获取所有项目标题

### API端点
- `GET /api/message-query` - 查询接口
- 支持参数：`startDate`, `endDate`, `userId`, `conversationId`

## 重要说明

### 会话ID概念澄清
- **会话ID就是项目ID**：在本系统中，每个项目(project)就是一个会话，因此会话ID实际上就是项目的UUID
- **conversation_id字段**：这是项目表中的一个独立字段，不是会话标识符
- **查询逻辑**：当您输入会话ID进行查询时，系统会使用这个ID去匹配项目的主键ID

## 注意事项

1. **性能考虑**：查询结果限制为5000条记录，避免性能问题
2. **数据安全**：使用DEFINER权限确保数据库访问安全
3. **错误处理**：完善的错误提示和异常处理机制
4. **用户体验**：响应式设计，支持移动端访问
5. **会话ID格式**：会话ID应为标准的UUID格式（例如：469efd43-f8e5-4a6e-96e8-541c634f3a31）

## 故障排除

### 常见问题
- **查询无结果**：检查查询条件是否正确，确认数据库中存在相关记录
- **导出失败**：确保浏览器允许文件下载
- **加载慢**：大量数据查询时请耐心等待，或缩小查询范围

### 技术支持
如遇到技术问题，请联系开发团队或查看系统日志获取详细错误信息。
