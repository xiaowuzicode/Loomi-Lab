# Loomi Pay ä¸»åº”ç”¨æ¥å…¥æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜äº†å¦‚ä½•å°†æ‚¨çš„ä¸»åº”ç”¨æ¥å…¥ Loomi Pay ç‹¬ç«‹æ”¯ä»˜å¾®æœåŠ¡ã€‚Loomi Pay é‡‡ç”¨å¼‚æ­¥äº‹ä»¶é©±åŠ¨æ¶æ„ï¼Œé€šè¿‡ API è°ƒç”¨å’Œ Redis Streams æ¶ˆæ¯é˜Ÿåˆ—å®ç°ä¸ä¸»åº”ç”¨çš„è§£è€¦é€šä¿¡ã€‚

## ğŸ—ï¸ æ¶æ„æ¦‚è§ˆ

```mermaid
graph TD
    A[ä¸»åº”ç”¨] -->|1. åˆ›å»ºæ”¯ä»˜è®¢å•| B[Loomi Pay API]
    B -->|2. è¿”å›è®¢å•ä¿¡æ¯| A
    B -->|3. å‘å¸ƒä»»åŠ¡æ¶ˆæ¯| C[Redis Streams]
    D[æ”¯ä»˜å¤„ç†å™¨] -->|4. æ¶ˆè´¹ä»»åŠ¡| C
    D -->|5. è°ƒç”¨æ‹‰å¡æ‹‰| E[æ‹‰å¡æ‹‰æ”¯ä»˜]
    E -->|6. å¼‚æ­¥å›è°ƒ| F[Webhookå¤„ç†]
    F -->|7. å‘å¸ƒç»“æœæ¶ˆæ¯| C
    A -->|8. ç›‘å¬ç»“æœæ¶ˆæ¯| C
    
    subgraph "Loomi Pay æœåŠ¡"
        B
        C
        D
        F
        G[PostgreSQL]
    end
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. ç¯å¢ƒè¦æ±‚

- **ç½‘ç»œè®¿é—®**: ç¡®ä¿ä¸»åº”ç”¨å¯ä»¥è®¿é—® Loomi Pay æœåŠ¡
- **Redis è¿æ¥**: éœ€è¦è¿æ¥åˆ°åŒä¸€ä¸ª Redis å®ä¾‹
- **HTTPS**: ç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨ HTTPS
- **API Key**: ä» Loomi Pay ç®¡ç†å‘˜è·å– API Key

### 2. åŸºç¡€é…ç½®

åœ¨æ‚¨çš„ä¸»åº”ç”¨ä¸­é…ç½®ä»¥ä¸‹å‚æ•°ï¼š

```env
# Loomi Pay æœåŠ¡é…ç½®
LOOMI_PAY_BASE_URL=https://pay.your-domain.com
LOOMI_PAY_API_KEY=your-super-secret-api-key-here

# Redis é…ç½®ï¼ˆä¸ Loomi Pay å…±äº«ï¼‰
REDIS_URL=redis://localhost:6379/0

# åº”ç”¨æ ‡è¯†
APP_ID=your_app_identifier
```

## ğŸ“¡ API æ¥å£è¯¦è§£

### è®¤è¯æ–¹å¼

æ‰€æœ‰ API è¯·æ±‚éƒ½éœ€è¦åœ¨è¯·æ±‚å¤´ä¸­åŒ…å« API Keyï¼š

```http
Authorization: Bearer your-super-secret-api-key-here
Content-Type: application/json
```

### 1. åˆ›å»ºæ”¯ä»˜è®¢å•

**æ¥å£**: `POST /api/v1/payment-orders`

**ç”¨é€”**: åˆ›å»ºæ–°çš„æ”¯ä»˜è®¢å•ï¼Œæ”¯æŒæ”¯ä»˜å’Œå……å€¼ä¸¤ç§ç±»å‹

**è¯·æ±‚å‚æ•°**:

```json
{
  "app_id": "your_app_identifier",
  "merchant_order_id": "ORDER_20241203_001",
  "amount": 10000,
  "order_type": "payment",
  "subject": "è´­ä¹°VIPä¼šå‘˜",
  "currency": "CNY",
  "extra_data": {
    "user_id": "user_12345",
    "product_id": "vip_monthly",
    "return_url": "https://your-app.com/payment/return"
  }
}
```

**å‚æ•°è¯´æ˜**:

| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| app_id | string | âœ… | åº”ç”¨æ ‡è¯†ç¬¦ï¼Œç”¨äºåŒºåˆ†ä¸åŒçš„åº”ç”¨ |
| merchant_order_id | string | âœ… | å•†æˆ·è®¢å•å·ï¼Œåœ¨åŒä¸€app_idä¸‹å¿…é¡»å”¯ä¸€ |
| amount | integer | âœ… | é‡‘é¢ï¼Œå•ä½ä¸ºåˆ†ï¼ˆä¾‹å¦‚ï¼š10000 = 100.00å…ƒï¼‰ |
| order_type | string | âœ… | è®¢å•ç±»å‹ï¼š`payment`ï¼ˆæ”¯ä»˜ï¼‰æˆ– `recharge`ï¼ˆå……å€¼ï¼‰ |
| subject | string | âœ… | è®¢å•æ ‡é¢˜/å•†å“æè¿° |
| currency | string | âŒ | è´§å¸ç±»å‹ï¼Œé»˜è®¤ "CNY" |
| extra_data | object | âŒ | æ‰©å±•æ•°æ®ï¼Œå¯å­˜å‚¨ä¸šåŠ¡ç›¸å…³ä¿¡æ¯ |

**å“åº”ç¤ºä¾‹**:

```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "app_id": "your_app_identifier",
  "merchant_order_id": "ORDER_20241203_001",
  "status": "pending",
  "order_type": "payment",
  "amount": 10000,
  "currency": "CNY",
  "payment_gateway": "lakala",
  "gateway_transaction_id": null,
  "subject": "è´­ä¹°VIPä¼šå‘˜",
  "extra_data": {
    "user_id": "user_12345",
    "product_id": "vip_monthly",
    "return_url": "https://your-app.com/payment/return"
  },
  "created_at": "2024-12-03T10:30:00Z",
  "updated_at": "2024-12-03T10:30:00Z"
}
```

**çŠ¶æ€ç **:
- `202 Accepted`: è®¢å•åˆ›å»ºæˆåŠŸ
- `409 Conflict`: è®¢å•å·å·²å­˜åœ¨
- `400 Bad Request`: å‚æ•°é”™è¯¯
- `401 Unauthorized`: API Key æ— æ•ˆ

### 2. æŸ¥è¯¢æ”¯ä»˜è®¢å•

**æ¥å£**: `GET /api/v1/payment-orders/{merchant_order_id}?app_id={app_id}`

**ç”¨é€”**: æŸ¥è¯¢æŒ‡å®šè®¢å•çš„è¯¦ç»†ä¿¡æ¯å’Œå½“å‰çŠ¶æ€

**è¯·æ±‚ç¤ºä¾‹**:
```http
GET /api/v1/payment-orders/ORDER_20241203_001?app_id=your_app_identifier
Authorization: Bearer your-super-secret-api-key-here
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "app_id": "your_app_identifier",
  "merchant_order_id": "ORDER_20241203_001",
  "status": "succeeded",
  "order_type": "payment",
  "amount": 10000,
  "currency": "CNY",
  "payment_gateway": "lakala",
  "gateway_transaction_id": "LKL_20241203_123456",
  "subject": "è´­ä¹°VIPä¼šå‘˜",
  "extra_data": {
    "user_id": "user_12345",
    "product_id": "vip_monthly",
    "lakala_callback": {
      "payStatus": "S",
      "timestamp": "2024-12-03T10:35:00Z"
    }
  },
  "created_at": "2024-12-03T10:30:00Z",
  "updated_at": "2024-12-03T10:35:00Z"
}
```

**è®¢å•çŠ¶æ€è¯´æ˜**:
- `pending`: å¾…å¤„ç†
- `processing`: å¤„ç†ä¸­
- `succeeded`: æ”¯ä»˜æˆåŠŸ
- `failed`: æ”¯ä»˜å¤±è´¥

### 3. åˆ›å»ºé€€æ¬¾è®¢å•

**æ¥å£**: `POST /api/v1/refund-orders`

**ç”¨é€”**: å¯¹å·²æˆåŠŸæ”¯ä»˜çš„è®¢å•å‘èµ·é€€æ¬¾

**è¯·æ±‚å‚æ•°**:
```json
{
  "app_id": "your_app_identifier",
  "payment_order_id": "550e8400-e29b-41d4-a716-446655440000",
  "amount": 5000,
  "reason": "ç”¨æˆ·ç”³è¯·é€€æ¬¾"
}
```

**å‚æ•°è¯´æ˜**:

| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| app_id | string | âœ… | åº”ç”¨æ ‡è¯†ç¬¦ |
| payment_order_id | string | âœ… | åŸæ”¯ä»˜è®¢å•çš„UUID |
| amount | integer | âœ… | é€€æ¬¾é‡‘é¢ï¼ˆåˆ†ï¼‰ï¼Œä¸èƒ½è¶…è¿‡åŸæ”¯ä»˜é‡‘é¢ |
| reason | string | âŒ | é€€æ¬¾åŸå›  |

**å“åº”ç¤ºä¾‹**:
```json
{
  "id": "660f9500-f30c-42e5-b827-557766551111",
  "app_id": "your_app_identifier",
  "payment_order_id": "550e8400-e29b-41d4-a716-446655440000",
  "status": "pending",
  "amount": 5000,
  "currency": "CNY",
  "reason": "ç”¨æˆ·ç”³è¯·é€€æ¬¾",
  "gateway_refund_id": null,
  "extra_data": {},
  "created_at": "2024-12-03T11:00:00Z",
  "updated_at": "2024-12-03T11:00:00Z"
}
```

### 4. æŸ¥è¯¢é€€æ¬¾è®¢å•

**æ¥å£**: `GET /api/v1/refund-orders/{refund_order_id}?app_id={app_id}`

**ç”¨é€”**: æŸ¥è¯¢é€€æ¬¾è®¢å•çš„è¯¦ç»†ä¿¡æ¯å’ŒçŠ¶æ€

## ğŸ“¨ æ¶ˆæ¯é˜Ÿåˆ—é›†æˆ

### Redis Streams é…ç½®

Loomi Pay ä½¿ç”¨ Redis Streams è¿›è¡Œå¼‚æ­¥æ¶ˆæ¯é€šä¿¡ã€‚ä¸»åº”ç”¨éœ€è¦ç›‘å¬ä»¥ä¸‹ Streamï¼š

- **æ”¯ä»˜ç»“æœæµ**: `payment_results`
- **é€€æ¬¾ç»“æœæµ**: `refund_results`

### æ¶ˆæ¯æ ¼å¼

#### æ”¯ä»˜ç»“æœæ¶ˆæ¯

```json
{
  "event_type": "payment_status_changed",
  "payment_order_id": "550e8400-e29b-41d4-a716-446655440000",
  "app_id": "your_app_identifier",
  "merchant_order_id": "ORDER_20241203_001",
  "old_status": "processing",
  "new_status": "succeeded",
  "gateway_transaction_id": "LKL_20241203_123456",
  "amount": 10000,
  "timestamp": "2024-12-03T10:35:00Z"
}
```

#### é€€æ¬¾ç»“æœæ¶ˆæ¯

```json
{
  "event_type": "refund_status_changed",
  "refund_order_id": "660f9500-f30c-42e5-b827-557766551111",
  "payment_order_id": "550e8400-e29b-41d4-a716-446655440000",
  "app_id": "your_app_identifier",
  "old_status": "processing",
  "new_status": "succeeded",
  "gateway_refund_id": "LKL_REFUND_123456",
  "amount": 5000,
  "timestamp": "2024-12-03T11:05:00Z"
}
```

## ğŸ’» ä»£ç ç¤ºä¾‹

### Python ç¤ºä¾‹

```python
import requests
import redis
import json
from typing import Dict, Any, Optional

class LoomipayClient:
    def __init__(self, base_url: str, api_key: str, app_id: str, redis_url: str):
        self.base_url = base_url.rstrip('/')
        self.api_key = api_key
        self.app_id = app_id
        self.redis_client = redis.from_url(redis_url)
        self.headers = {
            'Authorization': f'Bearer {api_key}',
            'Content-Type': 'application/json'
        }
    
    def create_payment_order(self, 
                           merchant_order_id: str,
                           amount: int,
                           subject: str,
                           order_type: str = "payment",
                           extra_data: Optional[Dict[str, Any]] = None) -> Dict[str, Any]:
        """åˆ›å»ºæ”¯ä»˜è®¢å•"""
        url = f"{self.base_url}/api/v1/payment-orders"
        data = {
            "app_id": self.app_id,
            "merchant_order_id": merchant_order_id,
            "amount": amount,
            "order_type": order_type,
            "subject": subject,
            "extra_data": extra_data or {}
        }
        
        response = requests.post(url, json=data, headers=self.headers)
        response.raise_for_status()
        return response.json()
    
    def get_payment_order(self, merchant_order_id: str) -> Dict[str, Any]:
        """æŸ¥è¯¢æ”¯ä»˜è®¢å•"""
        url = f"{self.base_url}/api/v1/payment-orders/{merchant_order_id}"
        params = {"app_id": self.app_id}
        
        response = requests.get(url, params=params, headers=self.headers)
        response.raise_for_status()
        return response.json()
    
    def create_refund_order(self,
                           payment_order_id: str,
                           amount: int,
                           reason: Optional[str] = None) -> Dict[str, Any]:
        """åˆ›å»ºé€€æ¬¾è®¢å•"""
        url = f"{self.base_url}/api/v1/refund-orders"
        data = {
            "app_id": self.app_id,
            "payment_order_id": payment_order_id,
            "amount": amount,
            "reason": reason
        }
        
        response = requests.post(url, json=data, headers=self.headers)
        response.raise_for_status()
        return response.json()
    
    def listen_payment_results(self, consumer_group: str = "main_app"):
        """ç›‘å¬æ”¯ä»˜ç»“æœæ¶ˆæ¯"""
        stream_name = "payment_results"
        
        # åˆ›å»ºæ¶ˆè´¹è€…ç»„ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
        try:
            self.redis_client.xgroup_create(stream_name, consumer_group, id='0', mkstream=True)
        except redis.exceptions.ResponseError:
            pass  # ç»„å·²å­˜åœ¨
        
        while True:
            try:
                messages = self.redis_client.xreadgroup(
                    consumer_group,
                    f"{self.app_id}_consumer",
                    {stream_name: '>'},
                    count=1,
                    block=1000
                )
                
                for stream, msgs in messages:
                    for msg_id, fields in msgs:
                        # è§£ææ¶ˆæ¯
                        message_data = {k.decode(): v.decode() for k, v in fields.items()}
                        
                        # åªå¤„ç†å±äºå½“å‰åº”ç”¨çš„æ¶ˆæ¯
                        if message_data.get('app_id') == self.app_id:
                            self.handle_payment_result(message_data)
                            
                        # ç¡®è®¤æ¶ˆæ¯å·²å¤„ç†
                        self.redis_client.xack(stream_name, consumer_group, msg_id)
                        
            except Exception as e:
                print(f"å¤„ç†æ¶ˆæ¯æ—¶å‘ç”Ÿé”™è¯¯: {e}")
    
    def handle_payment_result(self, message_data: Dict[str, str]):
        """å¤„ç†æ”¯ä»˜ç»“æœ"""
        event_type = message_data.get('event_type')
        
        if event_type == 'payment_status_changed':
            merchant_order_id = message_data.get('merchant_order_id')
            new_status = message_data.get('new_status')
            
            print(f"è®¢å• {merchant_order_id} çŠ¶æ€å˜æ›´ä¸º: {new_status}")
            
            # æ ¹æ®çŠ¶æ€æ‰§è¡Œç›¸åº”çš„ä¸šåŠ¡é€»è¾‘
            if new_status == 'succeeded':
                self.handle_payment_success(message_data)
            elif new_status == 'failed':
                self.handle_payment_failure(message_data)
    
    def handle_payment_success(self, message_data: Dict[str, str]):
        """å¤„ç†æ”¯ä»˜æˆåŠŸ"""
        merchant_order_id = message_data.get('merchant_order_id')
        amount = int(message_data.get('amount', 0))
        
        # åœ¨è¿™é‡Œå®ç°æ‚¨çš„ä¸šåŠ¡é€»è¾‘
        # ä¾‹å¦‚ï¼šå‘æ”¾ç§¯åˆ†ã€æ¿€æ´»VIPã€å‘é€é€šçŸ¥ç­‰
        print(f"æ”¯ä»˜æˆåŠŸå¤„ç†: è®¢å•{merchant_order_id}, é‡‘é¢{amount}åˆ†")
    
    def handle_payment_failure(self, message_data: Dict[str, str]):
        """å¤„ç†æ”¯ä»˜å¤±è´¥"""
        merchant_order_id = message_data.get('merchant_order_id')
        
        # åœ¨è¿™é‡Œå®ç°æ‚¨çš„ä¸šåŠ¡é€»è¾‘
        # ä¾‹å¦‚ï¼šå›æ»šè®¢å•çŠ¶æ€ã€å‘é€å¤±è´¥é€šçŸ¥ç­‰
        print(f"æ”¯ä»˜å¤±è´¥å¤„ç†: è®¢å•{merchant_order_id}")

# ä½¿ç”¨ç¤ºä¾‹
if __name__ == "__main__":
    client = LoomipayClient(
        base_url="https://pay.your-domain.com",
        api_key="your-super-secret-api-key-here",
        app_id="your_app_identifier",
        redis_url="redis://localhost:6379/0"
    )
    
    # åˆ›å»ºæ”¯ä»˜è®¢å•
    order = client.create_payment_order(
        merchant_order_id="ORDER_20241203_001",
        amount=10000,  # 100.00å…ƒ
        subject="è´­ä¹°VIPä¼šå‘˜",
        extra_data={"user_id": "user_12345"}
    )
    print(f"åˆ›å»ºè®¢å•æˆåŠŸ: {order['id']}")
    
    # æŸ¥è¯¢è®¢å•çŠ¶æ€
    order_info = client.get_payment_order("ORDER_20241203_001")
    print(f"è®¢å•çŠ¶æ€: {order_info['status']}")
    
    # å¯åŠ¨æ¶ˆæ¯ç›‘å¬ï¼ˆåœ¨å•ç‹¬çš„çº¿ç¨‹æˆ–è¿›ç¨‹ä¸­è¿è¡Œï¼‰
    # client.listen_payment_results()
```

### Node.js ç¤ºä¾‹

```javascript
const axios = require('axios');
const Redis = require('redis');

class LoomipayClient {
    constructor(baseUrl, apiKey, appId, redisUrl) {
        this.baseUrl = baseUrl.replace(/\/$/, '');
        this.apiKey = apiKey;
        this.appId = appId;
        this.redis = Redis.createClient({ url: redisUrl });
        this.headers = {
            'Authorization': `Bearer ${apiKey}`,
            'Content-Type': 'application/json'
        };
    }
    
    async createPaymentOrder(merchantOrderId, amount, subject, orderType = 'payment', extraData = {}) {
        const url = `${this.baseUrl}/api/v1/payment-orders`;
        const data = {
            app_id: this.appId,
            merchant_order_id: merchantOrderId,
            amount,
            order_type: orderType,
            subject,
            extra_data: extraData
        };
        
        try {
            const response = await axios.post(url, data, { headers: this.headers });
            return response.data;
        } catch (error) {
            throw new Error(`åˆ›å»ºæ”¯ä»˜è®¢å•å¤±è´¥: ${error.response?.data?.detail || error.message}`);
        }
    }
    
    async getPaymentOrder(merchantOrderId) {
        const url = `${this.baseUrl}/api/v1/payment-orders/${merchantOrderId}`;
        const params = { app_id: this.appId };
        
        try {
            const response = await axios.get(url, { 
                headers: this.headers,
                params 
            });
            return response.data;
        } catch (error) {
            throw new Error(`æŸ¥è¯¢æ”¯ä»˜è®¢å•å¤±è´¥: ${error.response?.data?.detail || error.message}`);
        }
    }
    
    async createRefundOrder(paymentOrderId, amount, reason = null) {
        const url = `${this.baseUrl}/api/v1/refund-orders`;
        const data = {
            app_id: this.appId,
            payment_order_id: paymentOrderId,
            amount,
            reason
        };
        
        try {
            const response = await axios.post(url, data, { headers: this.headers });
            return response.data;
        } catch (error) {
            throw new Error(`åˆ›å»ºé€€æ¬¾è®¢å•å¤±è´¥: ${error.response?.data?.detail || error.message}`);
        }
    }
    
    async listenPaymentResults(consumerGroup = 'main_app') {
        await this.redis.connect();
        
        const streamName = 'payment_results';
        const consumerName = `${this.appId}_consumer`;
        
        // åˆ›å»ºæ¶ˆè´¹è€…ç»„
        try {
            await this.redis.xGroupCreate(streamName, consumerGroup, '0', {
                MKSTREAM: true
            });
        } catch (error) {
            // ç»„å·²å­˜åœ¨ï¼Œå¿½ç•¥é”™è¯¯
        }
        
        while (true) {
            try {
                const messages = await this.redis.xReadGroup(
                    consumerGroup,
                    consumerName,
                    [{ key: streamName, id: '>' }],
                    { COUNT: 1, BLOCK: 1000 }
                );
                
                for (const message of messages) {
                    for (const msg of message.messages) {
                        const messageData = msg.message;
                        
                        // åªå¤„ç†å±äºå½“å‰åº”ç”¨çš„æ¶ˆæ¯
                        if (messageData.app_id === this.appId) {
                            await this.handlePaymentResult(messageData);
                        }
                        
                        // ç¡®è®¤æ¶ˆæ¯å·²å¤„ç†
                        await this.redis.xAck(streamName, consumerGroup, msg.id);
                    }
                }
            } catch (error) {
                console.error('å¤„ç†æ¶ˆæ¯æ—¶å‘ç”Ÿé”™è¯¯:', error);
            }
        }
    }
    
    async handlePaymentResult(messageData) {
        const eventType = messageData.event_type;
        
        if (eventType === 'payment_status_changed') {
            const merchantOrderId = messageData.merchant_order_id;
            const newStatus = messageData.new_status;
            
            console.log(`è®¢å• ${merchantOrderId} çŠ¶æ€å˜æ›´ä¸º: ${newStatus}`);
            
            if (newStatus === 'succeeded') {
                await this.handlePaymentSuccess(messageData);
            } else if (newStatus === 'failed') {
                await this.handlePaymentFailure(messageData);
            }
        }
    }
    
    async handlePaymentSuccess(messageData) {
        const merchantOrderId = messageData.merchant_order_id;
        const amount = parseInt(messageData.amount);
        
        // åœ¨è¿™é‡Œå®ç°æ‚¨çš„ä¸šåŠ¡é€»è¾‘
        console.log(`æ”¯ä»˜æˆåŠŸå¤„ç†: è®¢å•${merchantOrderId}, é‡‘é¢${amount}åˆ†`);
    }
    
    async handlePaymentFailure(messageData) {
        const merchantOrderId = messageData.merchant_order_id;
        
        // åœ¨è¿™é‡Œå®ç°æ‚¨çš„ä¸šåŠ¡é€»è¾‘
        console.log(`æ”¯ä»˜å¤±è´¥å¤„ç†: è®¢å•${merchantOrderId}`);
    }
}

// ä½¿ç”¨ç¤ºä¾‹
async function main() {
    const client = new LoomipayClient(
        'https://pay.your-domain.com',
        'your-super-secret-api-key-here',
        'your_app_identifier',
        'redis://localhost:6379/0'
    );
    
    try {
        // åˆ›å»ºæ”¯ä»˜è®¢å•
        const order = await client.createPaymentOrder(
            'ORDER_20241203_001',
            10000, // 100.00å…ƒ
            'è´­ä¹°VIPä¼šå‘˜',
            'payment',
            { user_id: 'user_12345' }
        );
        console.log('åˆ›å»ºè®¢å•æˆåŠŸ:', order.id);
        
        // æŸ¥è¯¢è®¢å•çŠ¶æ€
        const orderInfo = await client.getPaymentOrder('ORDER_20241203_001');
        console.log('è®¢å•çŠ¶æ€:', orderInfo.status);
        
        // å¯åŠ¨æ¶ˆæ¯ç›‘å¬
        // await client.listenPaymentResults();
        
    } catch (error) {
        console.error('æ“ä½œå¤±è´¥:', error.message);
    }
}

// main();
```

## ğŸ”„ å®Œæ•´ä¸šåŠ¡æµç¨‹

### æ”¯ä»˜æµç¨‹

1. **å‘èµ·æ”¯ä»˜**
   ```python
   # ç”¨æˆ·åœ¨ä¸»åº”ç”¨ä¸­ç‚¹å‡»æ”¯ä»˜
   order = client.create_payment_order(
       merchant_order_id="ORDER_123",
       amount=10000,
       subject="è´­ä¹°VIP"
   )
   ```

2. **è·å–æ”¯ä»˜é“¾æ¥**
   ```python
   # ä»è¿”å›çš„è®¢å•ä¿¡æ¯ä¸­è·å–æ”¯ä»˜é“¾æ¥ï¼ˆé€šè¿‡åå°ä»»åŠ¡ç”Ÿæˆï¼‰
   # æˆ–è€…è½®è¯¢è®¢å•çŠ¶æ€ç›´åˆ°è·å¾—æ”¯ä»˜é“¾æ¥
   order_info = client.get_payment_order("ORDER_123")
   if order_info['status'] == 'processing':
       # å¼•å¯¼ç”¨æˆ·åˆ°æ”¯ä»˜é¡µé¢
       payment_url = order_info['extra_data']['payment_url']
   ```

3. **ç›‘å¬æ”¯ä»˜ç»“æœ**
   ```python
   # åœ¨åå°æœåŠ¡ä¸­ç›‘å¬æ”¯ä»˜ç»“æœ
   def handle_payment_success(message_data):
       merchant_order_id = message_data['merchant_order_id']
       # æ›´æ–°ç”¨æˆ·VIPçŠ¶æ€
       user_service.activate_vip(user_id)
       # å‘é€æˆåŠŸé€šçŸ¥
       notification_service.send_payment_success(user_id)
   ```

### é€€æ¬¾æµç¨‹

1. **å‘èµ·é€€æ¬¾**
   ```python
   # ç®¡ç†å‘˜æˆ–ç”¨æˆ·ç”³è¯·é€€æ¬¾
   refund = client.create_refund_order(
       payment_order_id=order['id'],
       amount=5000,  # éƒ¨åˆ†é€€æ¬¾
       reason="ç”¨æˆ·ç”³è¯·"
   )
   ```

2. **ç›‘å¬é€€æ¬¾ç»“æœ**
   ```python
   def handle_refund_success(message_data):
       # å›æ»šç”¨æˆ·æƒç›Š
       # å‘é€é€€æ¬¾æˆåŠŸé€šçŸ¥
       pass
   ```

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. å¹‚ç­‰æ€§å¤„ç†

- **merchant_order_id** åœ¨åŒä¸€ app_id ä¸‹å¿…é¡»å”¯ä¸€
- ç›¸åŒå‚æ•°çš„é‡å¤è¯·æ±‚ä¼šè¿”å›å·²å­˜åœ¨çš„è®¢å•
- å»ºè®®åœ¨è®¢å•å·ä¸­åŒ…å«æ—¶é—´æˆ³æˆ–éšæœºæ•°

### 2. é”™è¯¯å¤„ç†

```python
try:
    order = client.create_payment_order(...)
except requests.exceptions.HTTPError as e:
    if e.response.status_code == 409:
        # è®¢å•å·²å­˜åœ¨ï¼Œè·å–ç°æœ‰è®¢å•
        existing_order = client.get_payment_order(merchant_order_id)
    elif e.response.status_code == 401:
        # API Key æ— æ•ˆ
        logger.error("API Key è®¤è¯å¤±è´¥")
    else:
        # å…¶ä»–é”™è¯¯
        logger.error(f"åˆ›å»ºè®¢å•å¤±è´¥: {e}")
```

### 3. æ¶ˆæ¯å¤„ç†

- ç¡®ä¿æ¶ˆæ¯å¤„ç†çš„å¹‚ç­‰æ€§
- åˆç†è®¾ç½®æ¶ˆè´¹è€…ç»„å’Œæ¶ˆè´¹è€…åç§°
- åŠæ—¶ç¡®è®¤æ¶ˆæ¯ä»¥é¿å…é‡å¤å¤„ç†
- å¤„ç†æ¶ˆæ¯å¤±è´¥æ—¶çš„é‡è¯•æœºåˆ¶

### 4. å®‰å…¨å»ºè®®

- å¦¥å–„ä¿ç®¡ API Keyï¼Œä¸è¦æäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶
- ä½¿ç”¨ HTTPS è¿›è¡Œ API é€šä¿¡
- å®šæœŸè½®æ¢ API Key
- ç›‘æ§å¼‚å¸¸çš„ API è°ƒç”¨

### 5. æ€§èƒ½ä¼˜åŒ–

- ä½¿ç”¨è¿æ¥æ± å¤ç”¨ HTTP è¿æ¥
- åˆç†è®¾ç½®è¶…æ—¶æ—¶é—´
- å¯¹é¢‘ç¹æŸ¥è¯¢çš„è®¢å•çŠ¶æ€è¿›è¡Œç¼“å­˜
- æ‰¹é‡å¤„ç†æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯

## ğŸ”§ æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜

1. **API è°ƒç”¨å¤±è´¥**
   - æ£€æŸ¥ API Key æ˜¯å¦æ­£ç¡®
   - ç¡®è®¤ç½‘ç»œè¿é€šæ€§
   - æŸ¥çœ‹ Loomi Pay æœåŠ¡æ—¥å¿—

2. **æ¶ˆæ¯æ— æ³•æ¥æ”¶**
   - ç¡®è®¤ Redis è¿æ¥é…ç½®
   - æ£€æŸ¥æ¶ˆè´¹è€…ç»„æ˜¯å¦åˆ›å»ºæˆåŠŸ
   - éªŒè¯ app_id æ˜¯å¦åŒ¹é…

3. **è®¢å•çŠ¶æ€å¼‚å¸¸**
   - æŸ¥çœ‹æ‹‰å¡æ‹‰å›è°ƒæ—¥å¿—
   - æ£€æŸ¥ç­¾åéªŒè¯æ˜¯å¦é€šè¿‡
   - ç¡®è®¤å›è°ƒåœ°å€æ˜¯å¦å¯è®¿é—®

### æ—¥å¿—ç›‘æ§

å»ºè®®åœ¨ä¸»åº”ç”¨ä¸­æ·»åŠ ä»¥ä¸‹ç›‘æ§ï¼š

```python
import logging

# é…ç½®æ—¥å¿—
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# API è°ƒç”¨æ—¥å¿—
logger.info(f"åˆ›å»ºæ”¯ä»˜è®¢å•: {merchant_order_id}, é‡‘é¢: {amount}")

# æ¶ˆæ¯å¤„ç†æ—¥å¿—
logger.info(f"æ”¶åˆ°æ”¯ä»˜ç»“æœ: {message_data}")

# é”™è¯¯æ—¥å¿—
logger.error(f"æ”¯ä»˜å¤„ç†å¤±è´¥: {error}", exc_info=True)
```

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰ä»»ä½•é—®é¢˜ï¼Œè¯·è”ç³»ï¼š

- **æŠ€æœ¯æ–‡æ¡£**: [GitHub Wiki](https://github.com/your-org/loomi-pay/wiki)
- **é—®é¢˜åé¦ˆ**: [GitHub Issues](https://github.com/your-org/loomi-pay/issues)
- **é‚®ç®±æ”¯æŒ**: tech-support@your-domain.com

---

**æœ€åæ›´æ–°**: 2024å¹´12æœˆ3æ—¥  
**æ–‡æ¡£ç‰ˆæœ¬**: v1.0.0
