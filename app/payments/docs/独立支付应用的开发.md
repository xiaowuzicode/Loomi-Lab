# 独立支付应用的开发

### **AI 项目支付服务 - 技术架构文档**

- **版本**: 1.0
- **日期**: 2025年9月3日
- **作者**: BMad-Method Architect (Winston)

### 1. 简介

本文档旨在为新的AI项目支付服务提供全面的技术架构设计。该服务是一个独立的、支持多应用的微服务，旨在处理所有与资金相关的操作，包括支付、退款和充值，并通过与主应用（AI项目）的积分/Token体系解耦，保证系统的安全性、独立性和可扩展性。

### 2. 高层架构

- **架构风格**: 独立微服务（多租户模式）。
- **通信模式**: 采用基于消息队列（Redis Streams）的异步事件驱动模式，确保主应用与支付服务之间的松耦合和高可靠性。
- **核心职责**:
    - **主应用**: 负责管理业务逻辑（订单、用户、积分/Token兑换规则）。
    - **支付服务**: 专门处理资金流动（收款、退款），不感知上层业务逻辑。
- **架构图**:Code snippet
    
    `graph TD
        subgraph "客户端应用群 (多租户)"
            App1["AI 应用 1"]
            App2["AI 应用 2"]
        end
    
        subgraph "独立支付微服务 (Python/FastAPI)"
            PaymentAPI["支付API"]
            PaymentService["核心支付逻辑 (后台任务)"]
            PaymentDB[("独立 PostgreSQL 数据库<br>(支付/退款流水)")]
        end
    
        MQ("消息队列<br>(Redis Streams)")
        Lakala["拉卡拉 API"]
    
        App1 -- "1. 请求支付(带app_id)" --> PaymentAPI
        App2 -- "1. 请求支付(带app_id)" --> PaymentAPI
        PaymentAPI -- "2. 发布任务消息" --> MQ
        PaymentService -- "3. 消费任务消息" --> MQ
        PaymentService -- "4. 调用拉卡拉" --> Lakala
        Lakala -- "5. 异步回调" --> PaymentAPI
        PaymentAPI -- "6. 验证回调并发布结果消息" --> MQ
        App1 -- "7. 接收结果" --> MQ
        App2 -- "7. 接收结果" --> MQ
        PaymentService -- "读写数据" --> PaymentDB`
    

### 3. 技术栈

| 类别 | 技术 | 版本/说明 | 目的 |
| --- | --- | --- | --- |
| **语言** | Python | 3.11+ | 主开发语言 |
| **Web框架** | FastAPI | 最新稳定版 | 构建高性能、异步API |
| **数据库** | PostgreSQL | 最新稳定版 | 可靠的关系型数据存储 |
| **数据库平台** | Supabase | 新建独立项目 | 提供独立的DBaaS，便于管理 |
| **消息队列** | Redis | 7.0+ | 使用Streams功能实现可靠的异步消息传递 |
| **ORM** | SQLAlchemy | 最新稳定版 | 数据模型定义与数据库交互 |
| **数据库迁移** | Alembic | 最新稳定版 | 管理数据库表结构变更 |

Export to Sheets

### 4. 数据库设计

为保证安全和数据独立，支付服务使用独立的数据库。核心表结构如下：

- **支付单表 (`payment_orders`)**SQL
    
    `CREATE TABLE payment_orders (
        id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
        app_id VARCHAR(100) NOT NULL, -- 标识来源的AI应用
        merchant_order_id VARCHAR(255) NOT NULL, 
        status VARCHAR(50) NOT NULL CHECK (status IN ('pending', 'processing', 'succeeded', 'failed')), 
        order_type VARCHAR(50) NOT NULL DEFAULT 'payment' CHECK (order_type IN ('payment', 'recharge')), 
        amount BIGINT NOT NULL, -- 金额，单位为“分”
        currency VARCHAR(10) NOT NULL DEFAULT 'CNY', 
        payment_gateway VARCHAR(50) NOT NULL DEFAULT 'lakala',
        gateway_transaction_id VARCHAR(255), 
        metadata JSONB, 
        created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
        updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
        UNIQUE (app_id, merchant_order_id)
    );`
    
- **退款单表 (`refund_orders`)**SQL
    
    `CREATE TABLE refund_orders (
        id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
        app_id VARCHAR(100) NOT NULL, -- 标识来源的AI应用
        payment_order_id UUID NOT NULL REFERENCES payment_orders(id), -- 关联到原始的支付单
        status VARCHAR(50) NOT NULL CHECK (status IN ('pending', 'processing', 'succeeded', 'failed')),
        amount BIGINT NOT NULL, -- 退款金额（单位：分）
        currency VARCHAR(10) NOT NULL DEFAULT 'CNY',
        reason TEXT,
        gateway_refund_id VARCHAR(255),
        metadata JSONB,
        created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
        updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
    );`
    

### 5. API 接口规范

- **安全**: 所有内部API (`/api/v1/*`) 均需通过API Key进行认证。外部Webhook (`/webhooks/*`) 需通过签名验证。
- **幂等性**: `POST /api/v1/payment-orders` 需通过 `app_id` 和 `merchant_order_id` 的唯一性约束实现幂等。
- **核心接口**:
    1. **`POST /api/v1/payment-orders` (创建支付单)**
        - **用途**: 供主应用调用，启动支付或充值。
        - **请求体**:JSON
            
            `{
              "app_id": "ai_project_alpha",
              "merchant_order_id": "YOUR_APP_ORDER_123",
              "amount": 100, // 金额(分)
              "order_type": "recharge", // 'payment' 或 'recharge'
              "subject": "充值1000积分"
            }`
            
        - **响应**: `202 Accepted`，返回创建的支付单信息（状态为 `pending`）。
    2. **`POST /webhooks/lakala` (接收拉卡拉回调)**
        - **用途**: 接收拉卡拉的异步支付结果。
        - **核心逻辑**: **必须实现拉卡拉的签名验证**。验证通过后，更新支付单状态，并发布结果消息到Redis Streams。
    3. **`POST /api/v1/refund-orders` (创建退款单)**
        - **用途**: 供主应用后台调用，发起退款。
        - **请求体**:JSON
            
            `{
              "app_id": "ai_project_alpha",
              "payment_order_id": "d8e8f8f8-...",
              "amount": 100, // 退款金额(分)
              "reason": "用户申请"
            }`
            
        - **响应**: `202 Accepted`。
    4. **`GET /api/v1/payment-orders/{merchant_order_id}` (查询支付单详情)**
        - **用途**: 供主应用后台查询支付详情。
        - **参数**: `merchant_order_id` 在URL路径中，`app_id` 作为查询参数 `?app_id=ai_project_alpha`。
        - **响应**: `200 OK`，返回支付单的完整信息。

### 6. 初步开发计划 (Epic 1)

- **目标**: 构建服务基础框架，实现核心收款闭环。
- **任务顺序**:
    1. **项目初始化与环境设置**: 搭建FastAPI项目，配置依赖和环境变量。
    2. **数据库与模型设置**: 使用SQLAlchemy和Alembic创建上述数据表模型和迁移脚本。
    3. **实现创建支付单接口**: 开发 `POST /api/v1/payment-orders`，实现数据入库和发布消息到Redis。
    4. **开发支付处理后台任务**: 创建Redis Streams消费者，集成拉卡拉SDK，调用其API。
    5. **实现拉卡拉Webhook接口**: 开发 `POST /webhooks/lakala`，实现签名验证和状态更新。
    6. **实现支付结果通知**: 在Webhook处理成功后，将最终结果发布到另一个Redis Streams主题，供主应用消费。